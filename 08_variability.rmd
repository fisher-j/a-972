---
title: Variability
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

```{r}
library(rgl)
setupKnitr()
```

# Structural complexity index

SCI measures the spatial variability in a given tree attribute such as DBH or height. It is driven by differences between neighboring trees. We can calculate SCI based on residual trees only, or include ingrowth. The latter would be expected to increase the SCI, but it is unclear whether or not this kind of structural diversity is of significant importance.

It is important to keep in mind that SCI, for our study, refers to heterogeneity on the within-patch scale: at the .08 ha scale. Larger plots would be needed if we are to characterize structural variability at greater scales.

Finally, I realized that Zenner and following researchers definitions of SCI is a little confusing because they confuse bars around a vector as meaning absolute value, when in fact it means the norm of a vector (specifically the L~2~ norm, or )

First I'll identify trees of interest as live residual trees only: no ingrowth.

```{r}

ingrowth <- define_xy(ingrowth)

sci_d <- d_l %>%
  filter(live) %>%
  bind_rows(ingrowth, .id = "cohort") %>%
  mutate(year = factor(year, ordered = FALSE))

```

And the graphing function I'll use for visualizing these metrics.

```{r}

my_dodge <- position_dodge(0.4)

var_fig <- function(data) {
  # yr_breaks <- c(2008, 2013, 2018)
  data %>%
    filter(year != "init") %>%
    relevel_treatment() %>%
    # mutate(year = fix_year(year)) %>%
    ggplot(aes(year, avg, color = treatment, group = treatment)) +
      geom_line(size = 1, position = my_dodge) +
      geom_point(position = my_dodge) +
    # geom_ribbon(aes(ymin = sh_n_ci_lb, ymax = sh_n_ci_ub, fill = treatment), alpha = 0.2, color = NA) +
      geom_errorbar(
        aes(ymin = LB, ymax = UB),
        width = .75,
        position = my_dodge
      ) +
      theme_bw() +
      # scale_x_continuous(breaks = yr_breaks) +
      labs(y = NULL, x = "Year")
}

```

# SCI summarized by treatment

```{r}

sci_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarize(val = calc_sci(x, y, dbh))

sci_treat <- sci_plot %>%
  summarize(avg = mean(val), ci(val))
  
sci_treat %>%
  filter(year != "13") %>%
  color_groups(digits = 2, caption = "Average SCI and confidence interval for all live trees including ingrowth")

var_fig(sci_treat)

```

I thought I would try to see if any differences showed up by using a mixed model to control for differences in plot. The means come out the same, but what I notice is that the error bars are smaller in the emmeans.

```{r}

sci_mod <- lmer(val ~ treatment * year + (1 | plot), data = subset(sci_plot, year != "init"))

summary(sci_mod)

emmeans(sci_mod,  ~ treatment + year) %>% as.data.frame() %>%
  rename(avg = emmean, LB = lower.CL, UB = upper.CL) %>%
  var_fig()


```


Some of these trajectories look interesting, but They don't look unique, given the error bars.

# Shannon-Weaver index

This index calculates tree species diversity based on the number of stems.

```{r}

sh_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarise(val = calc_sh(spp))

sh_treat <- sh_plot %>%
  summarize(avg = mean(val), ci(val))
  
sh_treat %>%
  filter(year != "13") %>%
  color_groups(digits = 2, caption = "Average Shannon-Weaver index (stem based)")


var_fig(sh_treat)
```

# Mean directional index

```{r}

mdi_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarise(val = mean(calc_mdi(x, y)))

mdi_treat <- mdi_plot %>%
  summarize(avg = mean(val), ci(val))
  
mdi_treat %>%
  filter(year != "13") %>%
  color_groups(digits = 2, caption = "Average mean directional index (0: grid, 4:complete aggregation")

var_fig(mdi_treat)

```

# DBH~sd~

Standard deviation of DBH is a straightforward metric for estimating structural heterogeneity. 

```{r}

dbhsd_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarise(val = sd(dbh))

dbhsd_treat <- dbhsd_plot %>%
  summarize(avg = mean(val), ci(val))

var_fig(dbhsd_plot)
```

# Fun visual of SCI

Here I visualize the SCI_dbh_ for a random plot from each treatment

```{r, fig.width=8, fig.height=10}

sci_plots_d <- sci_d %>% select(x, y, z = dbh, plot, year) %>% split(~ plot + year)


visualize_plot_sdi <- function(data1) {
  data1 <- remove_coincident(data1)
  x <- data1$x - min(data1$x)
  y <- data1$y - min(data1$y)
  z <- data1$z
  col <- cm.colors(20)[1 + round(19*(z - min(z))/diff(range(z)))]
  dxy <- interp::tri.mesh(x, y, duplicate = "remove")
  persp3d(dxy, z, col = col, meshColor = "vertices")
  title3d(main = paste(data1$plot[[1]], data1$year[[1]]), edge = "x--")
  axes3d(xlen = 0, ylen = 0)
}

# visualize_plot_sdi(sci_plots_d[[30]])

open3d()
mfrow3d(nr = 5, nc = 2, sharedMouse = FALSE) 

for (i in sample(1:length(sci_plots_d), 10)) {
  next3d()
  visualize_plot_sdi(sci_plots_d[[i]])
}

rglwidget()

```

I can use the function described in `?rgl::persp3d.triSht` which uses the output of either package tripack or interp

Here are boxplots showing the variability in 2018 of some potentially important variables.

```{r}
p_h %>%
  filter(year == "18") %>%
  select(treatment, spp, dbh, ht, cr, ht_inc2) %>%
  pivot_longer(
    !c(treatment, spp),
    names_to = "measure",
    values_to = "value"
  ) %>%
  ggplot(aes(treatment, value)) +
    geom_boxplot() +
    facet_wrap(~ measure, scales = "free_y")
```

