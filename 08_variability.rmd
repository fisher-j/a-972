---
title: Variability
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

```

```{r}
library(rgl)
setupKnitr()
```

# Structural variability

Here I'll explore various metrics identified in the literature for quantifying and comparing structural variability and species variability

First I'll identify trees of interest as live trees including ingrowth. I'm not going to consider initial conditions here.

```{r}

ingrowth <- define_xy(ingrowth)

sci_d <- d_l %>%
  filter(live) %>%
  bind_rows(ingrowth, .id = "cohort") %>%
  mutate(year = factor(year, ordered = FALSE)) %>%
  filter(year != "init")

```

Here is the graphing function and emmeans generating function I'll use for visualizing these metrics. The mixed model I'm using is of the form: `plot_level_metric = treatment + year + treatment * year` with plot as a random variable. Any metric which does not inherently produce a plot level value is averaged at the plot level. 

```{r}

my_dodge <- position_dodge(0.4)

var_fig <- function(data) {
  # yr_breaks <- c(2008, 2013, 2018)
  data %>%
    filter(year != "init") %>%
    relevel_treatment() %>%
    # mutate(year = fix_year(year)) %>%
    ggplot(aes(year, emmean, color = treatment, group = treatment)) +
      geom_line(size = 1, position = my_dodge) +
      geom_point(position = my_dodge) +
    # geom_ribbon(aes(ymin = sh_n_ci_lb, ymax = sh_n_ci_ub, fill = treatment), alpha = 0.2, color = NA) +
      geom_errorbar(
        aes(ymin = lower.CL, ymax = upper.CL),
        width = .75,
        position = my_dodge
      ) +
      theme_bw() +
      # scale_x_continuous(breaks = yr_breaks) +
      labs(y = NULL, x = "Year")
}

var_mean <- function(plot_data) {
  mod <- lmer(val ~ treatment * year + (1 | plot), data = plot_data)
  emmeans(mod,  ~ treatment + year) %>% as.data.frame()
}

var_table <- function(mean_data, caption) {
  mean_data %>%
    filter(year != "13") %>%
    group_by(treatment) %>%
    arrange(treatment) %>%
    color_groups(digits = 2, caption)
}

```

# Structural complexity index

SCI measures the spatial variability in a given tree attribute such as DBH or height. It is driven by differences between neighboring trees. We can calculate SCI based on residual trees only, or include ingrowth. The latter would be expected to increase the SCI, but it is unclear whether or not this kind of structural diversity is of significant importance.

It is important to keep in mind that SCI, for our study, refers to heterogeneity on the within-patch scale: at the .08 ha scale. Larger plots would be needed if we are to characterize structural variability at greater scales.

Finally, I realized that Zenner and following researchers definitions of SCI is a little confusing because they confuse bars around a vector as meaning absolute value, when in fact it means the norm of a vector (specifically the L~2~ norm, or )

# SCI summarized by treatment

```{r}

sci_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarize(val = calc_sci(x, y, dbh))

sci_mean <- var_mean(sci_plot)
  
var_table(sci_mean, caption = "Average SCI and confidence interval for all live trees including ingrowth")

var_fig(sci_mean)

```

Some of these trajectories look interesting, but They don't look unique, given the error bars.

# Mean directional index

```{r}

mdi_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarize(val = mean(calc_mdi(x, y)))

mdi_mean <- var_mean(mdi_plot)
  
var_table(mdi_mean, caption = "Average mean directional index (0: grid, 4:complete aggregation")

var_fig(mdi_mean)

```

# DBH differentiation (TD)

This index is defined by FÃ¼ldner, (1995) as:

$$ TD_i = 1 - \frac{min(DBH_i, DBH_j)}{max(DBH_i, DBH_j)} $$

This is the single closest neighbor version, there is also a N neighbor version, Khuenhe used this one and found it was highly correlated with SCI and DBH~sd~

```{r}

TD_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarize(val = mean(calc_TD(x, y, dbh)))

TD_mean <- var_mean(TD_plot)
  
var_table(TD_mean, caption = "Average DBH differentiation, 0: similar tree sizes, approaching 1: more difference in neighbor tree size")

var_fig(TD_mean)

```

# DBH~sd~

Standard deviation of DBH is a straightforward metric for estimating structural heterogeneity. 

```{r}

dbhsd_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarize(val = sd(dbh))

dbhsd_mean <- var_mean(dbhsd_plot)
  
var_table(dbhsd_mean, caption = "Standard deviation of DBH")

var_fig(dbhsd_mean)

```

# Shannon-Weaver index

This index calculates tree species diversity based on the number of stems.

```{r}

sh_plot <- sci_d %>%
  group_by(treatment, year, plot) %>%
  summarize(val = calc_sh(x, y))

sh_mean <- var_mean(sh_plot)
  
var_table(sh_mean, caption = "Average Shannon-Weaver index (stem based)")

var_fig(sh_mean)

```

# Fun visual of SCI

Here I visualize the SCI_dbh_ for a random plot from each treatment

```{r, fig.width=8, fig.height=10}

sci_plots_d <- sci_d %>% select(x, y, z = dbh, plot, year) %>% split(~ plot + year, drop = TRUE)


visualize_plot_sdi <- function(data1) {
  data1 <- remove_coincident(data1)
  x <- data1$x - min(data1$x)
  y <- data1$y - min(data1$y)
  z <- data1$z
  col <- cm.colors(20)[1 + round(19*(z - min(z))/diff(range(z)))]
  dxy <- interp::tri.mesh(x, y, duplicate = "remove")
  persp3d(dxy, z, col = col, meshColor = "vertices")
  title3d(main = paste(data1$plot[[1]], data1$year[[1]]), edge = "x--")
  axes3d(xlen = 0, ylen = 0)
}

# visualize_plot_sdi(sci_plots_d[[30]])

open3d()
mfrow3d(nr = 5, nc = 2, sharedMouse = FALSE) 

for (i in sample(1:length(sci_plots_d), 10)) {
  next3d()
  visualize_plot_sdi(sci_plots_d[[i]])
}

rglwidget()

```

I can use the function described in `?rgl::persp3d.triSht` which uses the output of either package tripack or interp

Here are boxplots showing the variability in 2018 of some potentially important variables.

```{r}
p_h %>%
  filter(year == "18") %>%
  select(treatment, spp, dbh, ht, cr, ht_inc2) %>%
  pivot_longer(
    !c(treatment, spp),
    names_to = "measure",
    values_to = "value"
  ) %>%
  ggplot(aes(treatment, value)) +
    geom_boxplot() +
    facet_wrap(~ measure, scales = "free_y")
```

