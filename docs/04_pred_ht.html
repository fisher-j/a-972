<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Height increment model</title>

<script src="site_libs/header-attrs-2.13.3/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">A-972 10-year Study</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="01_import.html">Import data</a>
</li>
<li>
  <a href="02_data_cleaning.html">Detailed data cleaning</a>
</li>
<li>
  <a href="03_define.html">Define new data</a>
</li>
<li>
  <a href="04_pred_ht.html">Height increment model</a>
</li>
<li>
  <a href="05_analyzing_ba_increment.html">BAI modeling</a>
</li>
<li>
  <a href="06_summary.html">Summary statistics</a>
</li>
<li>
  <a href="07_initial_conditions.html">Comparing initial conditions</a>
</li>
<li>
  <a href="08_variability.html">Variability</a>
</li>
<li>
  <a href="09_damage.html">Bear and other damage</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Height increment model</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#defining-trees-of-interest">Defining trees of
interest</a></li>
<li><a
href="#assessment-of-linear-relationship-between-dbh-and-height-increment">Assessment
of linear relationship between dbh and height increment</a></li>
<li><a href="#global-model">Global Model</a></li>
<li><a href="#optimal-random-effects-specification">Optimal random
effects specification</a></li>
<li><a href="#choosing-a-sub-model-for-fixed-effects">Choosing a
sub-model for fixed effects</a></li>
<li><a href="#best-model-scrapping-above">Best model (scrapping
above)</a>
<ul>
<li><a href="#best-model-estimated-means">Best model estimated
means</a></li>
<li><a href="#best-model-validation">Best model validation</a>
<ul>
<li><a href="#residual-vs-fitted">Residual vs fitted</a></li>
<li><a href="#homogeneity-of-random-group-residuals">Homogeneity of
random group residuals</a></li>
<li><a href="#normality-of-residuals">Normality of residuals</a></li>
<li><a href="#leverage-and-cooks-distance">Leverage and Cooks
distance</a></li>
<li><a href="#random-effects-distribution">Random effects
distribution</a></li>
</ul></li>
</ul></li>
<li><a href="#update-data-with-predicted-heights">Update data with
predicted heights</a></li>
</ul>
</div>

<pre class="r"><code>library(lme4)</code></pre>
<pre><code>## Loading required package: Matrix</code></pre>
<pre><code>## 
## Attaching package: &#39;Matrix&#39;</code></pre>
<pre><code>## The following objects are masked from &#39;package:tidyr&#39;:
## 
##     expand, pack, unpack</code></pre>
<pre class="r"><code>library(emmeans)
library(MuMIn)
palette(&quot;Tableau 10&quot;)
library(broom.mixed)</code></pre>
<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>I need to predict missing heights in 2018 in order to complete other
steps of the analysis and provide better summary data. To accomplish
this, I will model height increment as a function of the continuous
predictor, dbh, as well as a combination of nested groupings: year,
treatment, plot, and species. Additionally, height increment response is
of interest in it’s own right. While height growth in trees is less
responsive to conditions then diameter, it would be important to see
whether there is a difference detected between treatments.</p>
</div>
<div id="defining-trees-of-interest" class="section level1">
<h1>Defining trees of interest</h1>
<p>First, I’ll define the dataset of interest as only years 2013 and
2018 observations of healthy, non-leaning, unbroken SESE or PSME trees.
I’ll also define three other alternative treatment groupings for
consideration: thinned/unthinned, H/L/C (thinning type), and 40/80/C
(thinning intensity).</p>
<p>I will predict height increment based on the beginning of period dbh.
Predicting based on the end of period dbh resulted in a lower AIC, but I
am defaulting to typical practice.</p>
<p>I’m also using height increment from both 2008 - 2013 and 2013 to
2018.</p>
<pre class="r"><code># test_d2 &lt;- d_l %&gt;%
#   group_by(tree_id) %&gt;%
#   filter(
#     spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;),
#     year %in% c(&quot;13&quot;, &quot;18&quot;),
#     live,
#     !get_cond(2, 3, 5),
#     !is.na(ht_inc2) &amp; !is.na(dbh)
#   ) %&gt;%
#   mutate(
#     treatment2 = str_extract(treatment, &quot;C|H|L&quot;),
#     treatment3 = str_extract(treatment, &quot;C|40|80&quot;),
#     treatment4 = if_else(str_detect(treatment, &quot;C&quot;), &quot;unthinned&quot;, &quot;thinned&quot;),
#     year = factor(year, levels = c(&quot;13&quot;, &quot;18&quot;), ordered = FALSE)
#   ) %&gt;%
#   select(starts_with(&quot;treatment&quot;), spp, year, tree_id, dbh, ht_inc2, plot, x, y)

test_d &lt;- d_l %&gt;%
  group_by(tree_id) %&gt;%
  filter(
    spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;),
    year %in% c(&quot;08&quot;, &quot;13&quot;),
    lead(live),
    !lead(get_cond(2, 3, 5)),
    !is.na(ht_inc1) &amp; !is.na(dbh),
  ) %&gt;%
  ungroup() %&gt;%
  mutate(
    treatment2 = str_extract(treatment, &quot;C|H|L&quot;),
    treatment3 = str_extract(treatment, &quot;C|40|80&quot;),
    treatment4 = if_else(str_detect(treatment, &quot;C&quot;), &quot;unthinned&quot;, &quot;thinned&quot;),
    year = factor(year, levels = c(&quot;08&quot;, &quot;13&quot;), ordered = FALSE)
  ) %&gt;%
  select(starts_with(&quot;treatment&quot;), spp, year, tree_id, dbh, ht_inc1, plot, x, y)

# test_d12 &lt;- d_l %&gt;%
#   group_by(tree_id) %&gt;%
#   filter(
#     spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;),
#     year %in% c(&quot;13&quot;),
#     lead(live),
#     !lead(get_cond(2, 3, 5)),
#     !is.na(ht_inc1) &amp; !is.na(dbh),
#   ) %&gt;%
#   ungroup() %&gt;%
#   mutate(
#     treatment2 = str_extract(treatment, &quot;C|H|L&quot;),
#     treatment3 = str_extract(treatment, &quot;C|40|80&quot;),
#     treatment4 = if_else(str_detect(treatment, &quot;C&quot;), &quot;unthinned&quot;, &quot;thinned&quot;),
#     year = factor(year, levels = c(&quot;13&quot;), ordered = FALSE)
#   ) %&gt;%
#   select(starts_with(&quot;treatment&quot;), spp, year, tree_id, dbh, ht_inc1, plot, x, y)</code></pre>
</div>
<div
id="assessment-of-linear-relationship-between-dbh-and-height-increment"
class="section level1">
<h1>Assessment of linear relationship between dbh and height
increment</h1>
<p>We are pretty sure that height growth is correlated with diameter, in
that larger trees are capable of more height growth than smaller ones.
We also think that this relationship is probably not linear. I will take
a look at log and square root transformations of dbh for linear
prediction of height growth.</p>
<pre class="r"><code>m0 &lt;- lm(ht_inc1 ~ dbh * treatment * spp, data = test_d)
m1 &lt;- update(m0, ~ sqrt(dbh) * treatment * spp)
m2 &lt;- update(m0, ~ log(dbh) * treatment * spp)


test_d %&gt;%
  ggplot(aes(x = dbh, y = ht_inc1, color = spp)) +
    geom_point(aes(color = spp), alpha = .5) +
    facet_wrap(vars(treatment)) +
    geom_line(aes(y = predict(m0), linetype = &quot;linear&quot;), size = 1) +
    geom_line(aes(y = predict(m1), linetype = &quot;sqrt&quot;), size = 1.25) + 
    geom_line(aes(y = predict(m2), linetype = &quot;log&quot;), size = 1.25) + 
    scale_color_manual(
      values = palette(),
      name = &quot;&quot;,
      breaks = c(&quot;PSMEM&quot;, &quot;SESE3&quot;, &quot;linear&quot;, &quot;sqrt&quot;, &quot;log&quot;),
    )</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-3-1.png" width="960" /></p>
<pre class="r"><code>rm(m0, m1, m2)</code></pre>
<p>It doesn’t look like it matters a whole lot with this noisy data. I’m
going to use log transformation.</p>
</div>
<div id="global-model" class="section level1">
<h1>Global Model</h1>
<p>The next step is going to specify our likely global model. In
general, we want to answer questions about how a given treatment
affected growth for each species. There may have also been different
responses between years. This will be a mixed model and I want to
control for the random effect of plot and tree_id. The global model will
include <code>log(dbh)</code> as well as the categories:
<code>treatment</code>, <code>species</code>, <code>year</code>, and all
their interactions. Resulting in the fixed effects:</p>
<p><code>ht_inc1 ~ log(dbh) * treatment * spp * year</code></p>
</div>
<div id="optimal-random-effects-specification" class="section level1">
<h1>Optimal random effects specification</h1>
<p>We will determine the optimal random effects structure using the
global fixed effects structure. I will select the best of the following
random effects structures:</p>
<pre><code>(1 | plot)
(1 | plot) + (1 | tree_id)
(log(dbh) | plot) + (1 | tree_id)</code></pre>
<p>I’ll do this using AIC and Restricted Maximum Likelihood Estimation
(REML), which I believe is the preferred method when comparing random
effects structure, whereas ML is necessary when comparing different
fixed effects.</p>
<pre class="r"><code>f0 &lt;- formula(ht_inc1 ~ log(dbh) * treatment * spp * year)
m0 &lt;- nlme::gls(f0, data = test_d, method = &quot;REML&quot;)
m1 &lt;- lmer(update(f0, ~ . + (1 | plot)), REML = TRUE, data = test_d)
m2 &lt;- update(m1, ~ . + (1 | tree_id))</code></pre>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<pre class="r"><code>m3 &lt;- update(m2, ~ . + (0 + log(dbh) | plot))</code></pre>
<pre><code>## boundary (singular) fit: see help(&#39;isSingular&#39;)</code></pre>
<pre class="r"><code>AIC(m0, m1, m2, m3)</code></pre>
<pre><code>##    df       AIC
## m0 41 1009.0492
## m1 42  980.7354
## m2 43  982.7354
## m3 44  984.7354</code></pre>
<p>The optimal random effects structure, includes the random intercept
only for <code>plot</code>. I will assume this random effects structure
in all further height models.</p>
</div>
<div id="choosing-a-sub-model-for-fixed-effects" class="section level1">
<h1>Choosing a sub-model for fixed effects</h1>
<p>The next step is to define a list of potential sub-models for fixed
effects to determine the optimal structure.</p>
<pre class="r"><code>fl &lt;- list(
  ht_inc1 ~ log(dbh) + (1 | plot),
  ht_inc1 ~ log(dbh) + spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment + spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp + treatment + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment * spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp * treatment * year + (1 | plot),
  ht_inc1 ~ log(dbh) + spp * year + treatment + (1 | plot),
  ht_inc1 ~ log(dbh) + spp + treatment * year + (1 | plot),
  ht_inc1 ~ log(dbh) * treatment * year + spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment + year + spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment2 + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment2 + spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp + treatment2 + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment2 * spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp * treatment2 * year + (1 | plot),
  ht_inc1 ~ log(dbh) + spp * year + treatment2 + (1 | plot),
  ht_inc1 ~ log(dbh) + spp + treatment2 * year + (1 | plot),
  ht_inc1 ~ log(dbh) * treatment2 * year + spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment2 + year + spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment3 + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment3 + spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp + treatment3 + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment3 * spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp * treatment3 * year + (1 | plot),
  ht_inc1 ~ log(dbh) + spp * year + treatment3 + (1 | plot),
  ht_inc1 ~ log(dbh) + spp + treatment3 * year + (1 | plot),
  ht_inc1 ~ log(dbh) * treatment3 * year + spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment3 + year + spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment4 + (1 | plot),
  ht_inc1 ~ log(dbh) * treatment4 + spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp + treatment4 + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment4 * spp + (1 | plot),
  ht_inc1 ~ log(dbh) * spp * treatment4 * year + (1 | plot),
  ht_inc1 ~ log(dbh) + spp * year + treatment4 + (1 | plot),
  ht_inc1 ~ log(dbh) + spp + treatment4 * year + (1 | plot),
  ht_inc1 ~ log(dbh) * treatment4 * year + spp + (1 | plot),
  ht_inc1 ~ log(dbh) + treatment4 + year + spp + (1 | plot)
)</code></pre>
<p>I use AIC to assess the fit of each of the models with coefficients
estimated with ML in order to compare among various fixed effects.</p>
<pre class="r"><code>get_aic(fl, data = test_d) %&gt;%
  kableExtra::kbl(caption = &quot;AICS for ht increment models&quot;) %&gt;%
  kableExtra::kable_styling(full_width = FALSE)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
AICS for ht increment models
</caption>
<thead>
<tr>
<th style="text-align:left;">
row
</th>
<th style="text-align:left;">
formula
</th>
<th style="text-align:right;">
aicc
</th>
<th style="text-align:right;">
rmse
</th>
<th style="text-align:left;">
r2
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
29
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * treatment3 * year + spp + (1 | plot)
</td>
<td style="text-align:right;">
836.6
</td>
<td style="text-align:right;">
0.311
</td>
<td style="text-align:left;">
0.11 / 0.13
</td>
</tr>
<tr>
<td style="text-align:left;">
38
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * treatment4 * year + spp + (1 | plot)
</td>
<td style="text-align:right;">
838.2
</td>
<td style="text-align:right;">
0.311
</td>
<td style="text-align:left;">
0.1 / 0.13
</td>
</tr>
<tr>
<td style="text-align:left;">
11
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * treatment * year + spp + (1 | plot)
</td>
<td style="text-align:right;">
839.5
</td>
<td style="text-align:right;">
0.309
</td>
<td style="text-align:left;">
0.12 / 0.14
</td>
</tr>
<tr>
<td style="text-align:left;">
10
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp + treatment * year + (1 | plot)
</td>
<td style="text-align:right;">
842.2
</td>
<td style="text-align:right;">
0.312
</td>
<td style="text-align:left;">
0.11 / 0.13
</td>
</tr>
<tr>
<td style="text-align:left;">
20
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * treatment2 * year + spp + (1 | plot)
</td>
<td style="text-align:right;">
845.2
</td>
<td style="text-align:right;">
0.311
</td>
<td style="text-align:left;">
0.1 / 0.13
</td>
</tr>
<tr>
<td style="text-align:left;">
35
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp * treatment4 * year + (1 | plot)
</td>
<td style="text-align:right;">
845.3
</td>
<td style="text-align:right;">
0.311
</td>
<td style="text-align:left;">
0.1 / 0.13
</td>
</tr>
<tr>
<td style="text-align:left;">
28
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp + treatment3 * year + (1 | plot)
</td>
<td style="text-align:right;">
845.4
</td>
<td style="text-align:right;">
0.313
</td>
<td style="text-align:left;">
0.1 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
17
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp * treatment2 * year + (1 | plot)
</td>
<td style="text-align:right;">
847.2
</td>
<td style="text-align:right;">
0.309
</td>
<td style="text-align:left;">
0.11 / 0.14
</td>
</tr>
<tr>
<td style="text-align:left;">
37
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp + treatment4 * year + (1 | plot)
</td>
<td style="text-align:right;">
849.0
</td>
<td style="text-align:right;">
0.313
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
26
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp * treatment3 * year + (1 | plot)
</td>
<td style="text-align:right;">
850.9
</td>
<td style="text-align:right;">
0.310
</td>
<td style="text-align:left;">
0.11 / 0.14
</td>
</tr>
<tr>
<td style="text-align:left;">
30
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment3 + year + spp + (1 | plot)
</td>
<td style="text-align:right;">
851.4
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
19
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp + treatment2 * year + (1 | plot)
</td>
<td style="text-align:right;">
851.7
</td>
<td style="text-align:right;">
0.313
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
24
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp + treatment3 + (1 | plot)
</td>
<td style="text-align:right;">
851.9
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
23
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment3 + spp + (1 | plot)
</td>
<td style="text-align:right;">
852.3
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
27
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp * year + treatment3 + (1 | plot)
</td>
<td style="text-align:right;">
853.1
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
25
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment3 * spp + (1 | plot)
</td>
<td style="text-align:right;">
854.1
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
39
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment4 + year + spp + (1 | plot)
</td>
<td style="text-align:right;">
854.3
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.08 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
33
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp + treatment4 + (1 | plot)
</td>
<td style="text-align:right;">
854.5
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.08 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
16
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment2 * spp + (1 | plot)
</td>
<td style="text-align:right;">
854.6
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
12
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment + year + spp + (1 | plot)
</td>
<td style="text-align:right;">
855.0
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
34
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment4 * spp + (1 | plot)
</td>
<td style="text-align:right;">
855.1
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.08 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
6
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp + treatment + (1 | plot)
</td>
<td style="text-align:right;">
855.2
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
8
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp * treatment * year + (1 | plot)
</td>
<td style="text-align:right;">
855.7
</td>
<td style="text-align:right;">
0.307
</td>
<td style="text-align:left;">
0.13 / 0.15
</td>
</tr>
<tr>
<td style="text-align:left;">
5
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment + spp + (1 | plot)
</td>
<td style="text-align:right;">
855.7
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
21
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment2 + year + spp + (1 | plot)
</td>
<td style="text-align:right;">
855.9
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
15
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp + treatment2 + (1 | plot)
</td>
<td style="text-align:right;">
855.9
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
36
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp * year + treatment4 + (1 | plot)
</td>
<td style="text-align:right;">
856.1
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.08 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
32
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * treatment4 + spp + (1 | plot)
</td>
<td style="text-align:right;">
856.4
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.08 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
9
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp * year + treatment + (1 | plot)
</td>
<td style="text-align:right;">
856.7
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
14
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment2 + spp + (1 | plot)
</td>
<td style="text-align:right;">
856.7
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.08 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
7
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment * spp + (1 | plot)
</td>
<td style="text-align:right;">
857.6
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.1 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
18
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp * year + treatment2 + (1 | plot)
</td>
<td style="text-align:right;">
857.7
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.09 / 0.12
</td>
</tr>
<tr>
<td style="text-align:left;">
3
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) * spp + (1 | plot)
</td>
<td style="text-align:right;">
861.4
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.05 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
2
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + spp + (1 | plot)
</td>
<td style="text-align:right;">
861.7
</td>
<td style="text-align:right;">
0.314
</td>
<td style="text-align:left;">
0.05 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
22
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment3 + (1 | plot)
</td>
<td style="text-align:right;">
865.0
</td>
<td style="text-align:right;">
0.316
</td>
<td style="text-align:left;">
0.08 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
4
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment + (1 | plot)
</td>
<td style="text-align:right;">
867.8
</td>
<td style="text-align:right;">
0.316
</td>
<td style="text-align:left;">
0.08 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
31
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment4 + (1 | plot)
</td>
<td style="text-align:right;">
867.9
</td>
<td style="text-align:right;">
0.316
</td>
<td style="text-align:left;">
0.08 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
13
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + treatment2 + (1 | plot)
</td>
<td style="text-align:right;">
868.7
</td>
<td style="text-align:right;">
0.316
</td>
<td style="text-align:left;">
0.08 / 0.11
</td>
</tr>
<tr>
<td style="text-align:left;">
1
</td>
<td style="text-align:left;">
ht_inc1 ~ log(dbh) + (1 | plot)
</td>
<td style="text-align:right;">
872.9
</td>
<td style="text-align:right;">
0.315
</td>
<td style="text-align:left;">
0.04 / 0.1
</td>
</tr>
</tbody>
</table>
<pre class="r"><code>lmod &lt;- function(fl) {
  lmer(fl, data = test_d, REML = TRUE)
}

summary(lm(ht_inc1 ~ log(dbh) + treatment4 * spp, data = test_d))</code></pre>
<pre><code>## 
## Call:
## lm(formula = ht_inc1 ~ log(dbh) + treatment4 * spp, data = test_d)
## 
## Residuals:
##      Min       1Q   Median       3Q      Max 
## -1.07861 -0.18844 -0.01071  0.20023  1.16646 
## 
## Coefficients:
##                              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)                  -0.18612    0.07916  -2.351   0.0188 *  
## log(dbh)                      0.18244    0.02407   7.580 5.93e-14 ***
## treatment4unthinned          -0.14800    0.02058  -7.190 1.00e-12 ***
## sppSESE3                     -0.08579    0.02075  -4.135 3.74e-05 ***
## treatment4unthinned:sppSESE3  0.07141    0.04545   1.571   0.1164    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 0.322 on 1537 degrees of freedom
## Multiple R-squared:  0.08316,    Adjusted R-squared:  0.08077 
## F-statistic: 34.85 on 4 and 1537 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>summary(lmod(fl[[32]]))</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: ht_inc1 ~ log(dbh) * treatment4 + spp + (1 | plot)
##    Data: test_d
## 
## REML criterion at convergence: 869.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.5336 -0.5870 -0.0200  0.6025  3.7332 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  plot     (Intercept) 0.003956 0.06289 
##  Residual             0.099708 0.31577 
## Number of obs: 1542, groups:  plot, 20
## 
## Fixed effects:
##                              Estimate Std. Error t value
## (Intercept)                  -0.19372    0.09972  -1.943
## log(dbh)                      0.17961    0.02966   6.056
## treatment4unthinned          -0.28388    0.17174  -1.653
## sppSESE3                     -0.07182    0.01867  -3.847
## log(dbh):treatment4unthinned  0.04983    0.05249   0.949
## 
## Correlation of Fixed Effects:
##             (Intr) lg(db) trtmn4 sSESE3
## log(dbh)    -0.980                     
## trtmnt4nthn -0.582  0.569              
## sppSESE3    -0.074  0.013  0.054       
## lg(dbh):tr4  0.556 -0.565 -0.973 -0.038</code></pre>
</div>
<div id="best-model-scrapping-above" class="section level1">
<h1>Best model (scrapping above)</h1>
<p>While these models are interesting, there is reason to believe that
our height measurements are not precise enough to capture the small
height differences between treatments (around 3 feet). For this reason,
I will default to a simple additive model that includes spp and
treatment.</p>
<pre class="r"><code>ht_inc_mod1 &lt;- lmod(fl[[32]])

summary(ht_inc_mod1)</code></pre>
<pre><code>## Linear mixed model fit by REML [&#39;lmerMod&#39;]
## Formula: ht_inc1 ~ log(dbh) * treatment4 + spp + (1 | plot)
##    Data: test_d
## 
## REML criterion at convergence: 869.2
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -3.5336 -0.5870 -0.0200  0.6025  3.7332 
## 
## Random effects:
##  Groups   Name        Variance Std.Dev.
##  plot     (Intercept) 0.003956 0.06289 
##  Residual             0.099708 0.31577 
## Number of obs: 1542, groups:  plot, 20
## 
## Fixed effects:
##                              Estimate Std. Error t value
## (Intercept)                  -0.19372    0.09972  -1.943
## log(dbh)                      0.17961    0.02966   6.056
## treatment4unthinned          -0.28388    0.17174  -1.653
## sppSESE3                     -0.07182    0.01867  -3.847
## log(dbh):treatment4unthinned  0.04983    0.05249   0.949
## 
## Correlation of Fixed Effects:
##             (Intr) lg(db) trtmn4 sSESE3
## log(dbh)    -0.980                     
## trtmnt4nthn -0.582  0.569              
## sppSESE3    -0.074  0.013  0.054       
## lg(dbh):tr4  0.556 -0.565 -0.973 -0.038</code></pre>
<p>Here is the summary table of the model used for predicting height
increments and thus heights</p>
<pre class="r"><code>sjPlot::tab_model(ht_inc_mod1,
  dv.labels = &quot;Height increment&quot;,
  show.ci = FALSE,
  show.se = TRUE,
  show.icc = FALSE
)</code></pre>
<pre><code>## Registered S3 method overwritten by &#39;parameters&#39;:
##   method                         from      
##   format.parameters_distribution datawizard</code></pre>
<table style="border-collapse:collapse; border:none;">
<tr>
<th style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm;  text-align:left; ">
 
</th>
<th colspan="3" style="border-top: double; text-align:center; font-style:normal; font-weight:bold; padding:0.2cm; ">
Height increment
</th>
</tr>
<tr>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  text-align:left; ">
Predictors
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
Estimates
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
std. Error
</td>
<td style=" text-align:center; border-bottom:1px solid; font-style:italic; font-weight:normal;  ">
p
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
(Intercept)
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
-0.19
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.10
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.052
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
dbh [log]
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.18
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.03
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
<strong>&lt;0.001</strong>
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
treatment4 [unthinned]
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
-0.28
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.17
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.099
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
spp [SESE3]
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
-0.07
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.02
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
<strong>&lt;0.001</strong>
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; ">
dbh [log] * treatment4<br>[unthinned]
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.05
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.05
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:center;  ">
0.343
</td>
</tr>
<tr>
<td colspan="4" style="font-weight:bold; text-align:left; padding-top:.8em;">
Random Effects
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
σ<sup>2</sup>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.10
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
τ<sub>00</sub> <sub>plot</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.00
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
N <sub>plot</sub>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
20
</td>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm; border-top:1px solid;">
Observations
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left; border-top:1px solid;" colspan="3">
1542
</td>
</tr>
<tr>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; text-align:left; padding-top:0.1cm; padding-bottom:0.1cm;">
Marginal R<sup>2</sup> / Conditional R<sup>2</sup>
</td>
<td style=" padding:0.2cm; text-align:left; vertical-align:top; padding-top:0.1cm; padding-bottom:0.1cm; text-align:left;" colspan="3">
0.083 / 0.118
</td>
</tr>
</table>
<pre class="r"><code>modelsummary::modelsummary(ht_inc_mod1)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:center;">
Model 1
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
(Intercept)
</td>
<td style="text-align:center;">
-0.194
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:center;">
(0.100)
</td>
</tr>
<tr>
<td style="text-align:left;">
log(dbh)
</td>
<td style="text-align:center;">
0.180
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:center;">
(0.030)
</td>
</tr>
<tr>
<td style="text-align:left;">
treatment4unthinned
</td>
<td style="text-align:center;">
-0.284
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:center;">
(0.172)
</td>
</tr>
<tr>
<td style="text-align:left;">
sppSESE3
</td>
<td style="text-align:center;">
-0.072
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:center;">
(0.019)
</td>
</tr>
<tr>
<td style="text-align:left;">
log(dbh) × treatment4unthinned
</td>
<td style="text-align:center;">
0.050
</td>
</tr>
<tr>
<td style="text-align:left;">
</td>
<td style="text-align:center;">
(0.052)
</td>
</tr>
<tr>
<td style="text-align:left;">
sd__(Intercept)
</td>
<td style="text-align:center;">
0.063
</td>
</tr>
<tr>
<td style="text-align:left;box-shadow: 0px 1px">
sd__Observation
</td>
<td style="text-align:center;box-shadow: 0px 1px">
0.316
</td>
</tr>
<tr>
<td style="text-align:left;">
AIC
</td>
<td style="text-align:center;">
883.2
</td>
</tr>
<tr>
<td style="text-align:left;">
BIC
</td>
<td style="text-align:center;">
920.6
</td>
</tr>
<tr>
<td style="text-align:left;">
Log.Lik.
</td>
<td style="text-align:center;">
-434.596
</td>
</tr>
<tr>
<td style="text-align:left;">
REMLcrit
</td>
<td style="text-align:center;">
869.192
</td>
</tr>
</tbody>
</table>
<div id="best-model-estimated-means" class="section level2">
<h2>Best model estimated means</h2>
<p>switch to model 32</p>
<pre class="r"><code># changed model here treatment4
emmip(
  lmod(fl[[32]]),
  spp ~ dbh | treatment4,
  CIs = TRUE,
  plotit = FALSE,
  at = list(dbh = seq(10, 60, 2))
) %&gt;% 
  ggplot(aes(dbh, yvar, color = spp)) +
    geom_line() +
    facet_wrap(~ treatment4 ) +
    geom_ribbon(aes(ymin = LCL, ymax = UCL, color = NULL, fill = spp), alpha = .2) +
    theme_bw() +
    scale_color_manual(
      values = c(SESE3 = &quot;black&quot;, PSMEM = &quot;#969696&quot;),
      aesthetics = c(&quot;color&quot;, &quot;fill&quot;)
    ) +
    labs(y = &quot;Predicted ht increment&quot;)</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code>emmip(
  lmod(fl[[5]]),
  spp ~ dbh | treatment,
  CIs = TRUE,
  plotit = FALSE,
  at = list(dbh = seq(10, 60, 2))
) %&gt;% 
  ggplot(aes(dbh, yvar, color = spp)) +
    geom_line() +
    facet_wrap(~ treatment ) +
    theme_bw() +
    geom_ribbon(aes(ymin = LCL, ymax = UCL, color = NULL, fill = spp), alpha = .2) +
    scale_color_manual(
      values = c(SESE3 = &quot;black&quot;, PSMEM = &quot;#969696&quot;),
      aesthetics = c(&quot;color&quot;, &quot;fill&quot;)
      ) +
    labs(y = &quot;Predicted ht increment&quot;, title = &quot;alternative model with treatment and species&quot;)</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<pre class="r"><code>emmeans(ht_inc_mod1, pairwise ~ treatment4, by = c(&quot;spp&quot;))</code></pre>
<pre><code>## $emmeans
## spp = PSMEM:
##  treatment4 emmean     SE   df lower.CL upper.CL
##  thinned     0.394 0.0200 22.4    0.353    0.436
##  unthinned   0.274 0.0355 14.9    0.198    0.349
## 
## spp = SESE3:
##  treatment4 emmean     SE   df lower.CL upper.CL
##  thinned     0.322 0.0228 37.0    0.276    0.369
##  unthinned   0.202 0.0385 20.4    0.121    0.282
## 
## Degrees-of-freedom method: kenward-roger 
## Confidence level used: 0.95 
## 
## $contrasts
## spp = PSMEM:
##  contrast            estimate     SE   df t.ratio p.value
##  thinned - unthinned    0.121 0.0402 15.5   3.003  0.0087
## 
## spp = SESE3:
##  contrast            estimate     SE   df t.ratio p.value
##  thinned - unthinned    0.121 0.0402 15.5   3.003  0.0087
## 
## Degrees-of-freedom method: kenward-roger</code></pre>
</div>
<div id="best-model-validation" class="section level2">
<h2>Best model validation</h2>
<pre class="r"><code># augment data with fitted, residual cooks distance and leverage

augment1 &lt;- function(dat, mod) {
  dat %&gt;% mutate(
    fitted = fitted(mod),
    resid = resid(mod, type = &quot;pearson&quot;, scaled = TRUE),
    cooks = cooks.distance(mod),
    lev = hatvalues(mod)
  )
}

ht_inc_d &lt;- augment1(test_d, ht_inc_mod1)</code></pre>
<div id="residual-vs-fitted" class="section level3">
<h3>Residual vs fitted</h3>
<p>I also plot residual vs the predictor</p>
<pre class="r"><code>par(mfrow = c(1, 2))
plot(
  resid ~ fitted,
  data = ht_inc_d,
  pch = 16,
  xlab = &quot;fitted values&quot;,
  ylab = &quot;Scaled residuals&quot;,
  main = &quot;Residual vs fitted&quot;,
  col = 2
)
abline(0,0)
plot(
  resid ~ log(dbh),
  data = ht_inc_d,
  xlab = &quot;log(dbh)&quot;,
  ylab = &quot;Scaled residuals&quot;,
  main = &quot;Residual vs log(dbh)&quot;,
  col = 2,
  pch = 16
)
abline(0,0)</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-10-1.png" width="672" /></p>
<pre class="r"><code>with(
  model.frame(ht_inc_mod1),
  boxplot(
    resid(ht_inc_mod1, type = &quot;pearson&quot;) ~ spp,
    xlab = &quot;by spp&quot;,
    ylab = &quot;Residuals&quot;,
    main = &quot;Distribution of residuals by spp&quot;
  )
)</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-10-2.png" width="672" /></p>
</div>
<div id="homogeneity-of-random-group-residuals" class="section level3">
<h3>Homogeneity of random group residuals</h3>
<p>I can check that random group residuals are homogenous</p>
<pre class="r"><code>plot(
  ht_inc_mod1,
  resid(., scaled=TRUE) ~ fitted(.)| plot,
  abline = 0,
  pch = 16,
  xlab = &quot;Fitted values&quot;,
  ylab = &quot;Standardised residuals&quot;
)</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-11-1.png" width="672" /></p>
</div>
<div id="normality-of-residuals" class="section level3">
<h3>Normality of residuals</h3>
<p>Checking for normality of residuals. The tails are perhaps a bit fat,
I’m not sure if this requires attention or not.</p>
<pre class="r"><code>qqnorm(resid(ht_inc_mod1, type = &quot;pearson&quot;), pch=16, col = 1,  main = &quot;QQplot for pearosn residuals&quot;)
qqline(resid(ht_inc_mod1, type = &quot;pearson&quot;))</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-12-1.png" width="960" /></p>
</div>
<div id="leverage-and-cooks-distance" class="section level3">
<h3>Leverage and Cooks distance</h3>
<p>Cooks outliers, defined as &gt; 3 x mean(cooks distance) are colored
in red. None of these “outliers” seem like they would disproportionately
affect regression.</p>
<pre class="r"><code># Plot leverage against standardised residuals
plot(
  resid ~ lev,
  data = ht_inc_d,
  las = 1,
  ylab = &quot;Standardised residuals&quot;,
  xlab = &quot;Leverage&quot;,
  col = palette.colors(palette = &quot;tableau10&quot;, alpha = .5)[1],
  main = &quot;Leverage vs residuals&quot;,
  pch = 16
)
points(resid ~ lev, data = filter(ht_inc_d, cooks &gt; 3 * mean(cooks)), pch = 16, col =3)</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-13-1.png" width="960" /></p>
</div>
<div id="random-effects-distribution" class="section level3">
<h3>Random effects distribution</h3>
<p>The distribution of random effects (plots) should be roughly normal.
Here our distribution is skewed, <a href=""
title="https://stats.stackexchange.com/a/366500">from what I’ve
read</a>, this should not be a problem for estimates or their std’s.</p>
<pre class="r"><code>hist(as.vector(unlist(ranef(ht_inc_mod1)$plot)), col = 1)</code></pre>
<p><img src="04_pred_ht_files/figure-html/unnamed-chunk-14-1.png" width="672" /></p>
</div>
</div>
</div>
<div id="update-data-with-predicted-heights" class="section level1">
<h1>Update data with predicted heights</h1>
<p>I will start by predicting heights for Douglas-fir and Redwood only.
I can only predict heights for trees in year 13 and 18, and only if they
have a height in the previous period. I can predict heights for trees
whose crown status did not change from one measurement to the next. I
will be assuming that a broken tree resumes height growth at a “normal”
rate.</p>
<p>I’ll predict heights for all trees and then filter this to include
only observations of live trees that didn’t break, or get a dead top (or
start leaning) from one observation to the next.</p>
<pre class="r"><code>new_heights &lt;- d_l %&gt;%
  mutate(treatment4 = if_else(str_detect(treatment, &quot;C&quot;), &quot;unthinned&quot;, &quot;thinned&quot;)) %&gt;%
  filter(spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;)) %&gt;%
  mutate(pred_ht_inc = predict(ht_inc_mod1, newdata = .)) %&gt;%
  group_by(tree_id) %&gt;%
  mutate(
    pred_ht = lag(ht) + lag(pred_ht_inc) * 5,
    cond_chk = get_cond(2, 3, 5, 30, 31, 32, str = TRUE),
    ht_p = case_when(
      cond_chk == lag(cond_chk) &amp; live &amp; is.na(ht) ~ pred_ht,
      TRUE ~ ht
    )
  ) %&gt;%
  select(tree_id, year, ht_p) %&gt;%
  ungroup()</code></pre>
<p>Now I’ll update the data with height predictions for selected trees
and fill in available heights for other species that were not
predicted.</p>
<pre class="r"><code>if (&quot;ht_p&quot; %in% names(d_l)) d_l[&quot;ht_p&quot;] &lt;- NULL

d_l &lt;- left_join(d_l, new_heights, by = c(&quot;tree_id&quot;, &quot;year&quot;)) %&gt;%
  mutate(ht_p = if_else(spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;), ht_p, ht))</code></pre>
<pre class="r"><code>head(d_l)</code></pre>
<pre><code>## # A tibble: 6 x 28
##   plot  treatment tree_id   spp   h_dist   azi year    dbh    ht    cr status bear  rot   notes        cc cond  live     ba d_inc2 ht_inc2 ba_inc2 d_inc1 ht_inc1 ba_inc1      x      y sdi_plot  ht_p
##   &lt;chr&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;ord&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;  &lt;int&gt; &lt;lgl&gt; &lt;lgl&gt; &lt;chr&gt;     &lt;int&gt; &lt;chr&gt; &lt;lgl&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;
## 1 1H40  H40       1H40.1901 SESE3   12.9    10 init   27.4 23.5     30      1 FALSE FALSE BA_ac_ft~    NA &quot;&quot;    TRUE   591. NA       NA      NA     0       0        0    4.10e5 4.57e6    1090. 23.5 
## 2 1H40  H40       1H40.1901 SESE3   12.9    10 08     27.4 23.5     30      1 FALSE FALSE BA_ac_ft~    NA &quot;&quot;    TRUE   591.  0        0       0     0.102  -3.96     4.42 4.10e5 4.57e6     449. 23.5 
## 3 1H40  H40       1H40.1901 SESE3   12.9    10 13     27.9  3.66     0      5 FALSE NA    Top blow~    -1 &quot;3,7~ FALSE  613.  0.102   -3.96    4.42 NA      NA       NA    4.10e5 4.57e6     484.  3.66
## 4 1H40  H40       1H40.1901 SESE3   12.9    10 18     NA   NA       NA     -5 FALSE NA    &lt;NA&gt;         NA &quot;3,7~ FALSE   NA  NA       NA      NA    NA      NA       NA    4.10e5 4.57e6     556. NA   
## 5 1H40  H40       1H40.1902 SESE3   14.2    13 init   37.6 23.2     40      1 TRUE  FALSE X            NA &quot;&quot;    TRUE  1110. NA       NA      NA     0       0        0    4.10e5 4.57e6    1090. 23.2 
## 6 1H40  H40       1H40.1902 SESE3   14.2    13 08     37.6 23.2     40      1 TRUE  FALSE X            NA &quot;&quot;    TRUE  1110.  0        0       0     0.559  -0.671   34.2  4.10e5 4.57e6     449. 23.2</code></pre>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
