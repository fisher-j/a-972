<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Define new data</title>

<script src="site_libs/header-attrs-2.11/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">A-972 10-year Study</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="01_import.html">Import data</a>
</li>
<li>
  <a href="02_data_cleaning.html">Detailed data cleaning</a>
</li>
<li>
  <a href="03_define.html">Define new data</a>
</li>
<li>
  <a href="04_pred_ht.html">Height increment model</a>
</li>
<li>
  <a href="05_analyzing_ba_increment.html">BAI modeling</a>
</li>
<li>
  <a href="06_summary.html">Summary statistics</a>
</li>
<li>
  <a href="08_variability.html">Variability</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Define new data</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#defining-livedead-trees">Defining live/dead trees</a></li>
<li><a href="#define-diameter-basal-area-and-height-increment">Define diameter, basal area, and height increment</a></li>
<li><a href="#define-utm-coordinates-for-each-tree">Define UTM coordinates for each tree</a></li>
<li><a href="#diversity-measures">Diversity measures</a>
<ul>
<li><a href="#structural-diversity-sci">Structural diversity SCI</a></li>
<li><a href="#calculate-the-shannon-weaver-index">Calculate the Shannon-Weaver Index</a></li>
</ul></li>
<li><a href="#mean-directional-index">Mean directional index</a></li>
<li><a href="#dbh-differentiation-td">DBH differentiation (TD)</a></li>
<li><a href="#calculate-plot-sdi">Calculate plot SDI</a></li>
<li><a href="#standardize-crown-ratio">Standardize crown ratio</a>
<ul>
<li><a href="#update-post-harvest-data">Update post-harvest data</a></li>
</ul></li>
</ul>
</div>

<div id="defining-livedead-trees" class="section level1">
<h1>Defining live/dead trees</h1>
<p>Status and condition codes provided do not necessarily define mortality, because a broken tree, depending on species may still be alive or dead. I’ll define dead trees as:</p>
<ol style="list-style-type: decimal">
<li>snags or down snags (status -9 to -5, and 5 to 9)</li>
<li>trees broken below dbh and uprooted trees (status 30, 32)</li>
<li>any non-sprouting species broken above dbh (status 31)</li>
<li>any sprouting species broken below 3 meters</li>
<li>missing live trees</li>
</ol>
<pre class="r"><code>d_l &lt;- d_l %&gt;%
  mutate(
    live = case_when(
      status %in% c(5:9, -5:-9, -1)                                  ~ FALSE,
      status %in% c(30, 32)                                      ~ FALSE,
      (spp %in% c(&quot;PSMEM&quot;, &quot;PISI&quot;) &amp; status == 31)               ~ FALSE,
      (spp %in% c(&quot;SESE3&quot;, &quot;ALRU&quot;) &amp; status == 31 &amp; ht &lt; 3)      ~ FALSE,
      (spp %in% c(&quot;SESE3&quot;, &quot;ALRU&quot;) &amp; status == 31 &amp; lag(ht) &lt; 3) ~ FALSE,
      TRUE                                                       ~ TRUE
    )
  )

# Do any trees go from being dead to being alive?
nrow(filter(group_by(d_l, tree_id), any(!live &amp; lead(live))))</code></pre>
<pre><code>## [1] 0</code></pre>
</div>
<div id="define-diameter-basal-area-and-height-increment" class="section level1">
<h1>Define diameter, basal area, and height increment</h1>
<p>Here I will add annual height, diameter and basal area increments to the dataset. Increment will be defined on the observation level, meaning that it must apply to either the first or second measurement. This is significant for modeling, as I will be predicting an increment based on one period’s dbh observation. I’ll add increment data to both the beginning and ending observations to facilitate modeling based on either observation. *_inc1 will be assigned to the first measurement (refers to subsequent measurement) and *_inc2 will be assigned to the second (refers to previous measurement).</p>
<pre class="r"><code># Add diameter increment data and update post-harvest data
d_l &lt;- d_l %&gt;%
  group_by(tree_id) %&gt;%
  mutate(
    ba = pi * (dbh / 2)^2,
    d_inc2 = (dbh - lag(dbh, order_by = year)) / 5,
    ht_inc2 = (ht - lag(ht, order_by = year)) / 5,
    ba_inc2 = (ba - lag(ba, order_by = year)) / 5,
    d_inc1 = (lead(dbh, order_by = year) - dbh) / 5,
    ht_inc1 = (lead(ht, order_by = year) - ht) / 5,
    ba_inc1 = (lead(ba, order_by = year) - ba) / 5
  ) %&gt;%
  ungroup()</code></pre>
</div>
<div id="define-utm-coordinates-for-each-tree" class="section level1">
<h1>Define UTM coordinates for each tree</h1>
<pre class="r"><code>define_xy &lt;- function(data) {
  data %&gt;%
  left_join(plot_info[, c(&quot;plot&quot;, &quot;utm_x&quot;, &quot;utm_y&quot;)], by = &quot;plot&quot;) %&gt;%
  mutate(
    circular2xy(h_dist, azi, center.x = utm_x, center.y = utm_y)
  ) %&gt;%
  select(-c(utm_x, utm_y))
}

d_l &lt;- define_xy(d_l)</code></pre>
</div>
<div id="diversity-measures" class="section level1">
<h1>Diversity measures</h1>
<div id="structural-diversity-sci" class="section level2">
<h2>Structural diversity SCI</h2>
<p>After some experimentation, I determined that ingrowth does have an effect on SCI, especially for the more intense thinnings, supposedly because they let in more light and encourage more understory initiation.</p>
<p>I also confirmed that the SCI function works the same regardless of whether coordinates are plot coordinates or UTM coordinates.</p>
<p>First, here is my code for defining SCI. The area of a triangle is equal to 1/2 the magnitude of the cross product of two vectors representing sides of a triangle. The magnitude of a vector is the square root of the the sum of its values squared. This is also known as the norm and is denoted with single or double vertical bars.</p>
<pre class="r"><code>cross_product &lt;- function(a, b) {
  if(length(a)!=3 || length(b)!=3){
        stop(&quot;Cross product is only defined for 3D vectors.&quot;)
    }
  i1 &lt;- c(2, 3, 1)
  i2 &lt;- c(3, 1, 2)
  a[i1] * b[i2] - a[i2] * b[i1]
}

# area is the magnitude of two vectors
tri_area &lt;- function(tri, points) {
  apply(tri, 1, function(point) {
    AB &lt;- points[point[2], ] - points[point[1], ]
    AC &lt;- points[point[3], ] - points[point[1], ]
    0.5 * sqrt(sum(cross_product(AB, AC)^2))
  })
}

# Calculates plot average SCI
calc_sci &lt;- function(x, y, z) {
  points &lt;- as.matrix(cbind(x, y, z))
  deln_obj &lt;- geometry::delaunayn(points[, 1:2], output.options = &quot;Fa&quot;)
  area3d &lt;- sum(tri_area(deln_obj$tri, points))
  area2d &lt;- sum(deln_obj$areas)
  area3d / area2d
}</code></pre>
</div>
<div id="calculate-the-shannon-weaver-index" class="section level2">
<h2>Calculate the Shannon-Weaver Index</h2>
<pre class="r"><code>calc_sh &lt;- function(spp, val = 1) {
  d &lt;- data.frame(spp = spp, val = val)
  pro &lt;- aggregate(val ~ spp, data = d, function(x) sum(x) / sum(d$val))[[2]]
  -sum(pro * log(pro))
}</code></pre>
</div>
</div>
<div id="mean-directional-index" class="section level1">
<h1>Mean directional index</h1>
<p>Mean directional index is described slightly differently by (Corral-Rivas et al. 2010) and (Pommerening and Stoyan 2008) but I believe that they are equivalent representations. I’m using the latter with four :</p>
<p><span class="math display">\[\sqrt{ \left ( \sum_{j=1}^{4} \cos{a_{ij}} \right )^2 + \left ( \sum_{j=1}^{4} \sin{a_{ij}} \right )^2 } \]</span></p>
<p>Also, with this index, I am dropping extra coincident points, keeping the first.</p>
<pre class="r"><code># calculate MDI for one tree based on coordinats of self and neighbors
mdi_tree &lt;- function(focus, neighbors) {
  x &lt;- neighbors[[&quot;x&quot;]] - focus[[&quot;x&quot;]]
  y &lt;- neighbors[[&quot;y&quot;]] - focus[[&quot;y&quot;]]
  hypot &lt;- sqrt(x^2 + y^2)
  sin_theta &lt;- x / hypot
  cos_theta &lt;- y / hypot
  sqrt(sum(sin_theta)^2 + sum(cos_theta)^2)
}

# drop subsequent coincident points (keep first)
remove_coincident &lt;- function(DF) {
  dup &lt;- paste(DF$x, DF$y)
  if (anyDuplicated(dup)) {
    rem &lt;- which(duplicated(dup))
    DF &lt;- DF[-rem, ]
  }
  DF
}

# find index of k nearest neighbors given data frame with x and y
nearest &lt;- function(DF, k) {  
  # get matrix of distances
  distances &lt;- as.matrix(dist(DF[c(&quot;x&quot;, &quot;y&quot;)]))
  # get index of k neighbors for each row (excluding self)
  idx &lt;- seq(2, length.out = k)
  apply(distances, 1, function(x) order(x)[idx], simplify = FALSE) |&gt;
    as.data.frame(optional = TRUE)
}

# Given x and y coordinates calcualte
# MDI for each.
calc_mdi &lt;- function(x, y) {
  trees &lt;- data.frame(x = x, y = y)
  trees &lt;- remove_coincident(trees)
  idx &lt;- nearest(trees, k = 4)
  sapply(1:nrow(trees), function(x) mdi_tree(trees[x, ], trees[idx[[x]], ]))
}</code></pre>
</div>
<div id="dbh-differentiation-td" class="section level1">
<h1>DBH differentiation (TD)</h1>
<p>Here i’ll define the single neighbor version of the TD, this may help to reduce bias given our lack of edge correction. I am not going to remove coincident points here as they won’t affect the calculation, and I am assuming two trees that share a location are indeed closest neighbors.</p>
<pre class="r"><code>calc_TD &lt;- function(x, y, dbh) {
  DF &lt;- data.frame(x, y)
  idx &lt;- as.numeric(nearest(DF, k = 1)[1, ])
  DBH_ij &lt;- matrix(c(dbh, dbh[idx]), ncol = 2)
  apply(DBH_ij, 1, function(x) 1 - min(x) / max(x))
}</code></pre>
</div>
<div id="calculate-plot-sdi" class="section level1">
<h1>Calculate plot SDI</h1>
<p>For “live” trees only</p>
<pre class="r"><code>d_l &lt;- d_l %&gt;%
  group_by(plot) %&gt;%
  mutate(sdi_plot = sum(12.5 * (dbh * live / 25.4)^1.605, na.rm = TRUE)) %&gt;%
  ungroup()</code></pre>
</div>
<div id="standardize-crown-ratio" class="section level1">
<h1>Standardize crown ratio</h1>
<pre class="r"><code>d_l &lt;- d_l %&gt;%
  mutate(
    cr = case_when(
      cr %in% c(-999, -99) ~ NA_real_,
      cr == 0 &amp; is.na(ht)  ~ NA_real_,
      cr %in% 1:5          ~ 5,
      cr %in% 21:25        ~ 25,
      cr %in% 31:35        ~ 35,
      cr %in% 41:50        ~ 50,
      cr %in% 55:80        ~ 60,
      TRUE                 ~ cr
    )
  )</code></pre>
<div id="update-post-harvest-data" class="section level2">
<h2>Update post-harvest data</h2>
<p>Make sure that this is the last step</p>
<pre class="r"><code>p_h &lt;- filter(d_l, year &gt; &quot;init&quot;)</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
