<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Bear and other damage</title>

<script src="site_libs/header-attrs-2.13.3/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>









<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">A-972 10-year Study</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="01_import.html">Import data</a>
</li>
<li>
  <a href="02_data_cleaning.html">Detailed data cleaning</a>
</li>
<li>
  <a href="03_define.html">Define new data</a>
</li>
<li>
  <a href="04_pred_ht.html">Height increment model</a>
</li>
<li>
  <a href="05_analyzing_ba_increment.html">BAI modeling</a>
</li>
<li>
  <a href="06_summary.html">Summary statistics</a>
</li>
<li>
  <a href="07_initial_conditions.html">Comparing initial conditions</a>
</li>
<li>
  <a href="08_variability.html">Variability</a>
</li>
<li>
  <a href="09_damage.html">Bear and other damage</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Bear and other damage</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#bear-damage">Bear damage</a>
<ul>
<li><a href="#data-cleaning">data cleaning</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#modeling">Modeling</a></li>
</ul></li>
<li><a href="#logistic-regression">Logistic regression</a>
<ul>
<li><a href="#model-validation">Model validation</a></li>
</ul></li>
</ul>
</div>

<pre class="r"><code>require(tidyverse)
library(performance)</code></pre>
<div id="bear-damage" class="section level1">
<h1>Bear damage</h1>
<div id="data-cleaning" class="section level2">
<h2>data cleaning</h2>
<p>I’ll only consider live trees.</p>
<pre class="r"><code>bd &lt;- d_l %&gt;%
  filter(live) %&gt;%
  mutate(year = factor(year, ordered = FALSE)) %&gt;%
  select(-c(h_dist, azi, x, y, cc, live, ht))</code></pre>
<p>There are trees with “healed over” in the notes, most of these are in
2008. It makes sense if these trees are subsequently listed as not bear
damaged.</p>
<p>I’m assuming that any tree that goes from bear damaged in 2008 to not
bear damaged in 2013 is in fact healed and that any damage in 2018 is
new damage.</p>
<pre class="r"><code># # Use this to look at any &quot;healed&quot; trees
# bd %&gt;% 
#   group_by(tree_id) %&gt;%
#   filter(any(str_detect(tolower(notes), &quot;healed&quot;))) %&gt;%
#   color_groups()</code></pre>
<p>In looking at notes, trees trees that have “old bear damage” recorded
are treated inconsistently, some are recorded with bear damage, some
without. I’ll assume that trees recorded as not bear damaged are either
undamaged or completely healed, and subsequent damage implies a new bear
incidence of bear damage.</p>
<pre class="r"><code># # Use this to look at any &quot;old bd&quot; trees
# bd %&gt;% 
#   group_by(tree_id) %&gt;%
#   filter(any(str_detect(tolower(notes), &quot;old&quot;))) %&gt;%
#   color_groups()</code></pre>
<p>Are there trees that are recorded as bear damaged in one period and
then not in the next period? Put another way, are bear damaged trees
dropped from the list for one reason or another?</p>
<p>There are 64 trees that are dropped (all in 2013), of these, 14 are
subsequently listed as damaged (all in 2018). As stated above, I will
consider these valid occurrences of new damage.</p>
<pre class="r"><code>bear_dropped &lt;- bd %&gt;%
  group_by(tree_id) %&gt;%
  mutate(bear_dropped = lag(bear) &amp; !bear) %&gt;%
  filter(any(bear_dropped)) %&gt;%
  mutate(id = cur_group_id()) %&gt;%
  relocate(id) %&gt;%
  arrange(id)

# # all dropped bear damage trees occur in 2013
# filter(bear_dropped, bear_dropped) %&gt;% pull(year) %&gt;% unique()

# color_groups(bear_dropped)

# # trees that are re-attacked
# bear_dropped %&gt;%
#   filter(any(bear &amp; !lag(bear))) %&gt;%
#   mutate(id = cur_group_id(), .before = 1) %&gt;%
#   color_groups()</code></pre>
<p>I need to create another variable which indicates if the damage is
new for that period, when a trees goes from undamaged to damaged. I will
also count trees as new bear damage when the damage increases from one
period to the next ie. when condition code increases from 17 or 18 to 19
or 20.</p>
<pre class="r"><code># # this was used for ensuring all bear damage stuck with a tree throughout its life
# # I&#39;ve since decided to allow trees to &quot;completely heal,&quot; as the data seems to suggest this
# cum_logic &lt;- function(x) {
#   if (any(x)) {
#     idx &lt;- min(which(x))
#     x[idx:length(x)] &lt;- TRUE
#   }
#   return(x)
# }

bd &lt;- bd %&gt;%
  group_by(tree_id) %&gt;%
  mutate(
    bear_mag = as.numeric(get_cond(17, 18, 19, str = TRUE)),
    bear_new = bear &amp; year %in% c(&quot;init&quot;, &quot;08&quot;) | bear &amp; !lag(bear) | bear_mag &gt; lag(bear_mag),
    bear_new = if_else(is.na(bear_new), FALSE, bear_new)
    ) %&gt;%
  select(-bear_mag) %&gt;%
  ungroup()</code></pre>
<p>I’m going to drop alder and hemlock from the analysis, because they
are never attacked by bear. I’m also going to group Douglas-fir and
spruce together as “other”.</p>
<pre class="r"><code>bd &lt;- filter(bd, spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;, &quot;PISI&quot;)) %&gt;%
  mutate(spp2 = if_else(spp == &quot;SESE3&quot;, spp, &quot;OTHER&quot;))</code></pre>
</div>
<div id="summary" class="section level2">
<h2>Summary</h2>
<p>Here is percent new bear damage over time. The H40 and L40 treatments
seem to have the largest increases.</p>
<p>In the H40 treatment there is a decline in percent new bear damage in
two plots, whereas for the L40 treatment, only one declines, and it is
anomalous in that is the only plot that sees an increase from 2008 to
2013.</p>
<pre class="r"><code>bear_plot &lt;- function(data, var) {
  my_dodge = position_dodge(width = 0.5)
  ggplot(data, aes(year, {{var}}, color = treatment, group = treatment)) + 
    geom_line(position = my_dodge) +
    geom_point(position = my_dodge) +
    geom_errorbar(aes(ymin = {{var}} - se, ymax = {{var}} + se), width = 0.2, position = my_dodge)
}

bd %&gt;%
  # filter(year != &quot;init&quot;) %&gt;%
  group_by(year, treatment, plot) %&gt;% 
  summarize(pct_bear = sum(bear_new, na.rm = TRUE) / n()) %&gt;% 
  summarize(avg_pct_bear = mean(pct_bear), se = sd(pct_bear) / sqrt(n()) ) %&gt;% 
  bear_plot(avg_pct_bear) +
    labs(title = &quot;Average percent new bear damage for each treatment ±SE&quot;)</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-8-1.png" width="672" /></p>
<pre class="r"><code>bd %&gt;%
  # filter(year != &quot;init&quot;) %&gt;%
  group_by(year, treatment, plot) %&gt;% 
  summarize(cnt_bear = sum(bear_new, na.rm = TRUE)) %&gt;% 
  summarize( avg_cnt_bear = mean(cnt_bear), se = sd(cnt_bear) / sqrt(n()) ) %&gt;% 
  bear_plot(avg_cnt_bear) +
    labs(title = &quot;Average count new bear damage for each treatment ±SE&quot;)</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-8-2.png" width="672" /></p>
<pre class="r"><code>bd %&gt;%
  filter(year != &quot;init&quot;) %&gt;%
  group_by(year, treatment, plot) %&gt;% 
  summarize(pct_bear = sum(bear_new, na.rm = TRUE) / n()) %&gt;% 
  # summarize(avg_pct_bear = mean(pct_bear)) %&gt;% 
  ggplot(aes(year, pct_bear, color = treatment, group = plot)) + 
    geom_line(position = position_dodge(width = 0.4), size = 1, alpha = 0.6) +
    facet_wrap(~ treatment) +
    theme(legend.position = &quot;none&quot;) +
    geom_point(position = position_dodge(width = 0.4)) +
    scale_x_discrete(expand = expansion(mult = 0.2)) +
    labs(title = &quot;Actual percent new bear damage for each treatment&quot;)</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-8-3.png" width="672" /></p>
<pre class="r"><code>bd %&gt;%
  filter(year != &quot;init&quot;) %&gt;%
  group_by(treatment, year, plot) %&gt;%
  summarize(bear_new = sum(bear_new)) %&gt;%
  ungroup() %&gt;%
  ggplot(aes(str_extract(plot, &quot;\\d&quot;), bear_new, fill = year)) + 
    geom_col(position = &quot;dodge&quot;, color = &quot;black&quot;) +
    facet_wrap(~ treatment) +
    labs(
      title = &quot;Actual count new bear damage for each plot in treatment&quot;,
      y = &quot;Count of bear damage&quot;, x = &quot;Plot number&quot;  
    )</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-8-4.png" width="672" /></p>
<pre class="r"><code>bd %&gt;%
  filter(year != &quot;init&quot;) %&gt;%
  group_by(treatment, year, spp2) %&gt;%
  summarize(bear_new = sum(bear_new)) %&gt;%
  ungroup() %&gt;%
  ggplot(aes(treatment, bear_new, fill = fct_relevel(spp2, &quot;SESE3&quot;))) + 
    geom_col(position = &quot;stack&quot;, color = &quot;black&quot;) +
    facet_wrap(~ year) +
    labs(
      title = &quot;Total sum of new bear damage for each treatment/species&quot;,
      y = &quot;Count of bear damage&quot;,
      x = &quot;Treatment&quot;,
      fill = NULL
    )</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-8-5.png" width="672" /></p>
<pre class="r"><code>bd %&gt;%
  group_by(treatment, year, plot) %&gt;%
  summarize(bear_new = sum(bear_new)) %&gt;%
  ggplot(aes(year, bear_new, group = str_extract(plot, &quot;\\d&quot;))) + 
    geom_point(position = position_dodge(0.3), alpha = 0.5) +
    geom_line(position = position_dodge(0.3), size = 1, alpha = 0.5) +
    facet_wrap(~ treatment) +
    labs(
      title = &quot;Actual count new bear damage for each plot in treatment&quot;,
      y = &quot;Count of bear damage&quot;, x = &quot;Year&quot;  
    )</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-8-6.png" width="672" /></p>
</div>
<div id="modeling" class="section level2">
<h2>Modeling</h2>
<p>There are several potential to modeling this data.</p>
<ol style="list-style-type: decimal">
<li><p>Probability of bear damage could be modeled as binary data with a
generalized linear model binomial regression with logit link (logistic
regression). This, I think would be answering: for a random (average?)
tree from a given treatment, what is the probability that it would be
bear damaged? I’m not sure we have sufficient observations of damaged
trees characterize the distribution. In the case of prediction, we may
need to make adjustment for the <a
href="https://stats.stackexchange.com/questions/6067/does-an-unbalanced-sample-matter-when-doing-logistic-regression">imbalance
of response</a></p></li>
<li><p>Another approach is modeling <em>percent bear damage</em> at the
plot level. Here linear regression may work, but theoretically, our
response is bound by (0, 1). One recommendation here is <a
href="https://hansjoerg.me/2019/05/10/regression-modeling-with-proportion-data-part-1/">Beta
regression</a>.</p></li>
<li><p>Also at the plot level, we could model counts using Poisson or
negative binomial GLMM. This would answer the question: how many trees
can we expect to be bear damaged given a treatment. Here it would
probably be important to account for differences between treatments like
diameter increment and tree size.</p></li>
</ol>
</div>
</div>
<div id="logistic-regression" class="section level1">
<h1>Logistic regression</h1>
<p>We are modeling occurrence of new bear damage in 2013 and 2018. New
bear damage in 2008 is not really comparable as it represents
accumulated damage over an unspecified amount of time prior to
treatment.</p>
<p>My first model is additive and includes <code>treatment</code>,
<code>year</code>, <code>d_inc2</code>, <code>spp2</code> and random
slopes for <code>plot</code>, <em>and</em> <code>tree_id</code>.</p>
<pre class="r"><code>bdmd &lt;- subset(bd, year %in% c(&quot;13&quot;, &quot;18&quot;))


bm1 &lt;- glmer(
  bear_new ~ treatment + year + d_inc2 + spp2 + (1 | plot) + (1 | tree_id),
  family = binomial,
  data = bdmd
  )

summary(bm1)</code></pre>
<pre><code>## Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) [&#39;glmerMod&#39;]
##  Family: binomial  ( logit )
## Formula: bear_new ~ treatment + year + d_inc2 + spp2 + (1 | plot) + (1 |      tree_id)
##    Data: bdmd
## 
##      AIC      BIC   logLik deviance df.resid 
##    511.0    569.2   -245.5    491.0     2485 
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -0.9624 -0.1661 -0.0721 -0.0528 24.9678 
## 
## Random effects:
##  Groups  Name        Variance  Std.Dev. 
##  tree_id (Intercept) 1.729e-08 0.0001315
##  plot    (Intercept) 2.383e-02 0.1543790
## Number of obs: 2495, groups:  tree_id, 1318; plot, 20
## 
## Fixed effects:
##              Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)   -6.5527     0.5888 -11.128  &lt; 2e-16 ***
## treatmentH40   2.0192     0.5799   3.482 0.000497 ***
## treatmentH80   0.7222     0.5883   1.228 0.219621    
## treatmentL40   2.2082     0.5895   3.746 0.000180 ***
## treatmentL80   0.5037     0.6304   0.799 0.424249    
## year18         0.3485     0.2597   1.342 0.179713    
## d_inc2         0.8155     0.2478   3.291 0.001000 ***
## spp2SESE3      2.0051     0.3252   6.166 6.99e-10 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##             (Intr) trtH40 trtH80 trtL40 trtL80 year18 d_inc2
## treatmntH40 -0.693                                          
## treatmntH80 -0.706  0.788                                   
## treatmntL40 -0.730  0.801  0.761                            
## treatmntL80 -0.679  0.724  0.709  0.706                     
## year18      -0.251  0.024  0.005  0.026  0.001              
## d_inc2      -0.168 -0.233 -0.068 -0.173 -0.033 -0.053       
## spp2SESE3   -0.369 -0.070 -0.087  0.027 -0.045  0.020 -0.089</code></pre>
<p>check <code>allFit</code> output</p>
<pre class="r"><code>bm1.all &lt;- allFit(bm1)</code></pre>
<pre><code>## bobyqa : [OK]
## Nelder_Mead : [OK]
## nlminbwrap : [OK]
## nmkbw : [failed]
## optimx.L-BFGS-B : [OK]
## nloptwrap.NLOPT_LN_NELDERMEAD : [OK]
## nloptwrap.NLOPT_LN_BOBYQA : [OK]</code></pre>
<pre class="r"><code>summary(bm1.all)</code></pre>
<pre><code>## $which.OK
##                        bobyqa                   Nelder_Mead                    nlminbwrap                         nmkbw               optimx.L-BFGS-B nloptwrap.NLOPT_LN_NELDERMEAD 
##                          TRUE                          TRUE                          TRUE                         FALSE                          TRUE                          TRUE 
##     nloptwrap.NLOPT_LN_BOBYQA 
##                          TRUE 
## 
## $msgs
## $msgs$bobyqa
## [1] &quot;boundary (singular) fit: see help(&#39;isSingular&#39;)&quot;
## 
## $msgs$Nelder_Mead
## [1] &quot;Model failed to converge with max|grad| = 0.00411575 (tol = 0.002, component 1)&quot;
## 
## $msgs$nlminbwrap
## [1] &quot;boundary (singular) fit: see help(&#39;isSingular&#39;)&quot;
## 
## $msgs$`optimx.L-BFGS-B`
## [1] &quot;boundary (singular) fit: see help(&#39;isSingular&#39;)&quot;
## 
## $msgs$nloptwrap.NLOPT_LN_NELDERMEAD
## [1] &quot;Model failed to converge with max|grad| = 0.004486 (tol = 0.002, component 1)&quot;
## 
## $msgs$nloptwrap.NLOPT_LN_BOBYQA
## [1] &quot;boundary (singular) fit: see help(&#39;isSingular&#39;)&quot;
## 
## 
## $fixef
##                               (Intercept) treatmentH40 treatmentH80 treatmentL40 treatmentL80    year18    d_inc2 spp2SESE3
## bobyqa                          -6.552655     2.019177    0.7221943     2.208202    0.5036991 0.3484903 0.8155291  2.005079
## Nelder_Mead                     -6.552659     2.019241    0.7222265     2.208235    0.5038683 0.3485112 0.8155203  2.005038
## nlminbwrap                      -6.536237     2.021616    0.7207531     2.209154    0.5024763 0.3471309 0.8098878  2.001111
## optimx.L-BFGS-B                 -6.552820     2.019137    0.7221805     2.208211    0.5038025 0.3485291 0.8155745  2.005203
## nloptwrap.NLOPT_LN_NELDERMEAD   -6.552724     2.019199    0.7222062     2.208253    0.5034650 0.3484457 0.8155400  2.005102
## nloptwrap.NLOPT_LN_BOBYQA       -6.538346     2.016588    0.7218045     2.205725    0.5034200 0.3477317 0.8134501  2.002543
## 
## $llik
##                        bobyqa                   Nelder_Mead                    nlminbwrap               optimx.L-BFGS-B nloptwrap.NLOPT_LN_NELDERMEAD     nloptwrap.NLOPT_LN_BOBYQA 
##                     -245.5041                     -245.5042                     -245.5249                     -245.5041                     -245.5042                     -245.5061 
## 
## $sdcor
##                               tree_id.(Intercept) plot.(Intercept)
## bobyqa                               0.000000e+00     1.543678e-01
## Nelder_Mead                          2.225543e-03     1.541786e-01
## nlminbwrap                           0.000000e+00     2.567183e-06
## optimx.L-BFGS-B                      0.000000e+00     1.544038e-01
## nloptwrap.NLOPT_LN_NELDERMEAD        2.398934e-03     1.541111e-01
## nloptwrap.NLOPT_LN_BOBYQA            6.565217e-08     1.470071e-01
## 
## $theta
##                               tree_id.(Intercept) plot.(Intercept)
## bobyqa                               0.000000e+00     1.543678e-01
## Nelder_Mead                          2.225543e-03     1.541786e-01
## nlminbwrap                           0.000000e+00     2.567183e-06
## optimx.L-BFGS-B                      0.000000e+00     1.544038e-01
## nloptwrap.NLOPT_LN_NELDERMEAD        2.398934e-03     1.541111e-01
## nloptwrap.NLOPT_LN_BOBYQA            6.565217e-08     1.470071e-01
## 
## $times
##                               user.self sys.self elapsed user.child sys.child
## bobyqa                             1.61     0.00    1.61         NA        NA
## Nelder_Mead                        3.14     0.00    3.14         NA        NA
## nlminbwrap                         0.61     0.00    0.61         NA        NA
## optimx.L-BFGS-B                    3.40     0.01    3.42         NA        NA
## nloptwrap.NLOPT_LN_NELDERMEAD      4.64     0.00    4.65         NA        NA
## nloptwrap.NLOPT_LN_BOBYQA          0.73     0.00    0.73         NA        NA
## 
## $feval
##                        bobyqa                   Nelder_Mead                    nlminbwrap               optimx.L-BFGS-B nloptwrap.NLOPT_LN_NELDERMEAD     nloptwrap.NLOPT_LN_BOBYQA 
##                           357                          1073                            NA                            36                          1715                            24 
## 
## attr(,&quot;class&quot;)
## [1] &quot;summary.allFit&quot;</code></pre>
<p>For model 2, I’ll remove <code>tree_id</code> and see if the warnings
go away. They do, but the model is different.</p>
<pre class="r"><code>bm2 &lt;- glmer(bear_new ~ treatment + year + d_inc2 + spp2 + (1 | plot), family = binomial, data = bdmd)

summary(bm2)</code></pre>
<pre><code>## Generalized linear mixed model fit by maximum likelihood (Laplace Approximation) [&#39;glmerMod&#39;]
##  Family: binomial  ( logit )
## Formula: bear_new ~ treatment + year + d_inc2 + spp2 + (1 | plot)
##    Data: bdmd
## 
##      AIC      BIC   logLik deviance df.resid 
##    509.0    561.4   -245.5    491.0     2486 
## 
## Scaled residuals: 
##     Min      1Q  Median      3Q     Max 
## -0.9624 -0.1661 -0.0721 -0.0528 24.9674 
## 
## Random effects:
##  Groups Name        Variance Std.Dev.
##  plot   (Intercept) 0.02384  0.1544  
## Number of obs: 2495, groups:  plot, 20
## 
## Fixed effects:
##              Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)   -6.5527     0.5888 -11.130  &lt; 2e-16 ***
## treatmentH40   2.0192     0.5798   3.482 0.000497 ***
## treatmentH80   0.7222     0.5883   1.228 0.219588    
## treatmentL40   2.2082     0.5895   3.746 0.000180 ***
## treatmentL80   0.5037     0.6304   0.799 0.424271    
## year18         0.3485     0.2597   1.342 0.179713    
## d_inc2         0.8155     0.2478   3.291 0.001000 ***
## spp2SESE3      2.0051     0.3252   6.167 6.98e-10 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Correlation of Fixed Effects:
##             (Intr) trtH40 trtH80 trtL40 trtL80 year18 d_inc2
## treatmntH40 -0.693                                          
## treatmntH80 -0.706  0.788                                   
## treatmntL40 -0.730  0.801  0.761                            
## treatmntL80 -0.679  0.724  0.709  0.706                     
## year18      -0.251  0.024  0.005  0.026  0.001              
## d_inc2      -0.168 -0.233 -0.068 -0.173 -0.033 -0.053       
## spp2SESE3   -0.369 -0.070 -0.087  0.027 -0.045  0.020 -0.089</code></pre>
<p>Having a look at the initial model. Including <code>tree_id</code> as
a random effect doesn’t seem to contribute anything to the model, so I
look at the model with <code>plot</code> only.</p>
<pre class="r"><code>compare_performance(bm1, bm2)</code></pre>
<pre><code>## # Comparison of Model Performance Indices
## 
## Name |    Model |     AIC | AIC weights |     BIC | BIC weights | R2 (cond.) | R2 (marg.) |   ICC |  RMSE | Sigma | Log_loss | Score_log | Score_spherical
## ----------------------------------------------------------------------------------------------------------------------------------------------------------
## bm1  | glmerMod | 511.008 |       0.269 | 569.229 |       0.020 |      0.391 |      0.386 | 0.007 | 0.155 | 1.000 |    0.098 |    -1.987 |           0.017
## bm2  | glmerMod | 509.008 |       0.731 | 561.407 |       0.980 |      0.391 |      0.386 | 0.007 | 0.155 | 1.000 |    0.098 |    -1.987 |           0.017</code></pre>
<pre class="r"><code>b2_mean &lt;- emmeans(bm2, ~ treatment, type = &quot;response&quot;)
plot(b2_mean)</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-12-1.png" width="672" /></p>
<pre class="r"><code>emmeans(bm2, pairwise ~ spp2, type = &quot;response&quot;)</code></pre>
<pre><code>## $emmeans
##  spp2    prob      SE  df asymp.LCL asymp.UCL
##  OTHER 0.0073 0.00220 Inf   0.00404    0.0132
##  SESE3 0.0518 0.00961 Inf   0.03587    0.0742
## 
## Results are averaged over the levels of: treatment, year 
## Confidence level used: 0.95 
## Intervals are back-transformed from the logit scale 
## 
## $contrasts
##  contrast      odds.ratio     SE  df null z.ratio p.value
##  OTHER / SESE3      0.135 0.0438 Inf    1  -6.167  &lt;.0001
## 
## Results are averaged over the levels of: treatment, year 
## Tests are performed on the log odds ratio scale</code></pre>
<pre class="r"><code>pairs(b2_mean)</code></pre>
<pre><code>##  contrast  odds.ratio     SE  df null z.ratio p.value
##  C / H40        0.133 0.0770 Inf    1  -3.482  0.0045
##  C / H80        0.486 0.2857 Inf    1  -1.228  0.7352
##  C / L40        0.110 0.0648 Inf    1  -3.746  0.0017
##  C / L80        0.604 0.3809 Inf    1  -0.799  0.9310
##  H40 / H80      3.658 1.3929 Inf    1   3.406  0.0059
##  H40 / L40      0.828 0.3053 Inf    1  -0.513  0.9862
##  H40 / L80      4.552 2.0560 Inf    1   3.355  0.0071
##  H80 / L40      0.226 0.0921 Inf    1  -3.653  0.0024
##  H80 / L80      1.244 0.5806 Inf    1   0.468  0.9902
##  L40 / L80      5.499 2.5813 Inf    1   3.631  0.0026
## 
## Results are averaged over the levels of: year, spp2 
## P value adjustment: tukey method for comparing a family of 5 estimates 
## Tests are performed on the log odds ratio scale</code></pre>
<pre class="r"><code>pwpp(b2_mean)</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-12-2.png" width="672" /></p>
<pre class="r"><code>emmip(bm2, treatment ~ d_inc2, at = list(d_inc2 = seq(-0.5, 2.8, 0.1)), type = &quot;response&quot;)</code></pre>
<p><img src="09_damage_files/figure-html/unnamed-chunk-12-3.png" width="672" /></p>
<pre class="r"><code>b2_mean %&gt;% multcomp::cld(reversed = TRUE)</code></pre>
<pre><code>##  treatment    prob      SE  df asymp.LCL asymp.UCL .group
##  L40       0.05771 0.01664 Inf   0.03253    0.1004  1    
##  H40       0.04825 0.01379 Inf   0.02738    0.0837  1    
##  H80       0.01367 0.00425 Inf   0.00741    0.0251   2   
##  L80       0.01102 0.00418 Inf   0.00523    0.0231   2   
##  C         0.00669 0.00343 Inf   0.00244    0.0182   2   
## 
## Results are averaged over the levels of: year, spp2 
## Confidence level used: 0.95 
## Intervals are back-transformed from the logit scale 
## P value adjustment: tukey method for comparing a family of 5 estimates 
## Tests are performed on the log odds ratio scale 
## significance level used: alpha = 0.05 
## NOTE: Compact letter displays can be misleading
##       because they show NON-findings rather than findings.
##       Consider using &#39;pairs()&#39;, &#39;pwpp()&#39;, or &#39;pwpm()&#39; instead.</code></pre>
<p>This model seems to be working. Now I’ll do more model selection,
testing for interactions.</p>
<div id="model-validation" class="section level2">
<h2>Model validation</h2>
<p>I can check for over dispersion, and <a
href="https://stats.stackexchange.com/questions/568407/how-to-correct-underdispersion-in-logistic-regression">I
don’t think I need to worry about underdispersion</a></p>
<pre class="r"><code>compare_performance(bm1, bm2)</code></pre>
<pre><code>## # Comparison of Model Performance Indices
## 
## Name |    Model |     AIC | AIC weights |     BIC | BIC weights | R2 (cond.) | R2 (marg.) |   ICC |  RMSE | Sigma | Log_loss | Score_log | Score_spherical
## ----------------------------------------------------------------------------------------------------------------------------------------------------------
## bm1  | glmerMod | 511.008 |       0.269 | 569.229 |       0.020 |      0.391 |      0.386 | 0.007 | 0.155 | 1.000 |    0.098 |    -1.987 |           0.017
## bm2  | glmerMod | 509.008 |       0.731 | 561.407 |       0.980 |      0.391 |      0.386 | 0.007 | 0.155 | 1.000 |    0.098 |    -1.987 |           0.017</code></pre>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
