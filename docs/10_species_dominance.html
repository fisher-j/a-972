<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Species dominance</title>

<script src="site_libs/header-attrs-2.13.3/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/navigation-1.1/codefolding.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<script src="site_libs/kePrint-0.0.1/kePrint.js"></script>
<link href="site_libs/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.tab('show');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">A-972 10-year Study</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="01_import.html">Import data</a>
</li>
<li>
  <a href="02_data_cleaning.html">Detailed data cleaning</a>
</li>
<li>
  <a href="03_define.html">Define new data</a>
</li>
<li>
  <a href="04_pred_ht.html">Height increment model</a>
</li>
<li>
  <a href="05_analyzing_ba_increment.html">BAI modeling</a>
</li>
<li>
  <a href="06_summary.html">Summary statistics</a>
</li>
<li>
  <a href="07_initial_conditions.html">Comparing initial conditions</a>
</li>
<li>
  <a href="08_variability.html">Variability</a>
</li>
<li>
  <a href="09_damage.html">Bear and other damage</a>
</li>
<li>
  <a href="10_species_dominance.html">Species dominance</a>
</li>
<li>
  <a href="11_seed_sap.html">Seedling, sapling, and ingrowth</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">Species dominance</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#dominance-figure">Dominance figure</a></li>
<li><a href="#species-dominance-significance-test">Species dominance
significance test</a></li>
<li><a href="#huis-dominance-metric">Hui’s dominance metric</a></li>
</ul>
</div>

<pre class="r"><code>library(tidyverse)</code></pre>
<p>I’m interested in creating a measure of species dominance. I will
select the 4 largest trees per plot and then determine what proportion
of these are from each species. I will only consider and report on RW
and DF. I could augment this by showing the average size of the dominant
tree by species.</p>
<p>For this two function, the four highest ranking trees (height,
growth, or diameter) were selected from each plot these were aggregated
at the treatment level to determine the proportion of dominant trees in
each species.</p>
<p>If I want to do hypothesis testing, I need to have two datasets, one
of the raw data (counts of trees per plot) and one of the average
proportion. I may want to do this with all of my metrics. The final
aggregation may be able to be done with a single function, depending on
how data were aggregated for each metric. Qmd is the only metric where
the mean is not straight forward, as it is the square root of the mean
of squared diameters.</p>
<p>For this to make sense for heights, we will need to predict heights
for missing trees because the largest trees are missing heights in many
cases.</p>
<p>Although I refer to proportions here, this is of 100 TPH, so
multiplying by 100 gives TPH.</p>
<pre class="r"><code>spp_dom_raw &lt;- function(data = d_l, metrics = NULL, years = NULL) {
  if(is.null(years)) years &lt;- c(&quot;08&quot;, &quot;13&quot;, &quot;18&quot;)
  if(is.null(metrics)) metrics &lt;- c(&quot;dbh&quot;, &quot;ht_p&quot;, &quot;ba_inc2&quot;)
  raw &lt;- data %&gt;%
    filter(
      spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;),
      live | status %in% c(15, 16),
      year %in% years
    ) %&gt;%
    select(year, treatment, spp, plot, all_of(metrics)) %&gt;%
    pivot_longer(cols = all_of(metrics), names_to = &quot;measure&quot;) %&gt;%
    group_by(measure, year, treatment, plot) %&gt;%
    slice_max(order_by = value, n = 8, with_ties = FALSE) %&gt;%
    ungroup()
  missing &lt;- raw$measure[raw$value == 0 | is.na(raw$value)]
  if(length(missing) &gt; 0) {
    message &lt;- &quot;Measures missing values (entries removed):&quot;
    warning(paste(message, toString(unique(missing))))
  }
  filter(raw, value != 0)
}

spp_dom_cnt &lt;- function(...) {
  spp_dom_raw(...) %&gt;%
  count(measure, year, treatment, plot, spp) %&gt;%
  ungroup() %&gt;%
  complete(nesting(treatment, year, plot), spp, measure, fill = list(n = 0))
}

spp_dom_pct &lt;- function(...) {
  spp_dom_cnt(...) %&gt;%
    group_by(measure, treatment, year, spp) %&gt;%
    summarise(n = sum(n)) %&gt;%
    mutate(freq = n / sum(n)) %&gt;%
    arrange(measure, treatment, spp, year) %&gt;%
    ungroup()
}</code></pre>
<div id="dominance-figure" class="section level2">
<h2>Dominance figure</h2>
<pre class="r"><code>dominance_labels &lt;- as_labeller(
  c(
    ba_inc2 = &quot;BAI&quot;,
    dbh = &quot;DBH&quot;,
    ht_p = &quot;Height&quot;
  ),
  label_parsed
)

make_dominance_fig &lt;- function(...) {
  spp_dom_pct(...) %&gt;%
    relevel_treatment() %&gt;%
    mutate(
      measure = factor(measure, levels = c(&quot;dbh&quot;, &quot;ht_p&quot;, &quot;ba_inc2&quot;)),
      year = case_when(
        year == 13 &amp; measure == &quot;ba_inc2&quot; ~2010.5,
        year == 18 &amp; measure == &quot;ba_inc2&quot; ~2015.5,
        year == &quot;init&quot; ~2003,
        year == &quot;08&quot; ~2008,
        year == &quot;13&quot; ~2013,
        year == &quot;18&quot; ~2018
      )
    ) %&gt;%
    ggplot(aes(year, freq, fill = spp)) +
      geom_bar(position = &quot;stack&quot;, stat = &quot;identity&quot;, width = 4.5) +
      facet_grid(
        vars(measure),
        vars(treatment),
        labeller = labeller(measure = dominance_labels)
      ) +
      theme_bw() +
      theme(
        panel.spacing.x = unit(1.3, &quot;mm&quot;),
        legend.position = &quot;bottom&quot;,
        legend.title = element_blank(),
        legend.key.size = unit(4, &quot;mm&quot;),
        legend.box.spacing = element_blank(),
        panel.grid = element_blank(),
        # strip.background.y = element_blank(),
        strip.placement = &quot;outside&quot;,
        axis.text.x = element_text(angle = 90, vjust = 0.25)
      ) +
      # scale_x_continuous(breaks = yr_breaks) +
      scale_y_continuous(breaks = c(0, .5, 1)) +
      scale_x_continuous(
        breaks = c(2003, 2008, 2013, 2018),
        labels = c(&quot;Pre-trt&quot;, &quot;2008&quot;, &quot;2013&quot;, &quot;2018&quot;)) +
      scale_fill_manual(&quot;spp&quot;,
       values = c(SESE3 = &quot;black&quot;, PSMEM = &quot;#a0a0a0&quot;),
       labels = c(&quot;Redwood&quot;, &quot;Douglas-fir&quot;)
      ) +
      labs(y = &quot;Proportion&quot;, x = &quot;Year&quot;)
}

make_dominance_fig(years = c(&quot;init&quot;, &quot;08&quot;, &quot;13&quot;, &quot;18&quot;))</code></pre>
<pre><code>## Warning in spp_dom_raw(...): Measures missing values (entries removed): ba_inc2</code></pre>
<pre><code>## Warning: Removed 20 rows containing missing values (position_stack).</code></pre>
<p><img src="10_species_dominance_files/figure-html/10-species-dominance-3-1.png" width="336" /></p>
<pre class="r"><code>ggsave(
  filename = &quot;figs/dominance_fig.pdf&quot;,
  device = cairo_pdf,
  width = 8.84,
  height = 9,
  units = &quot;cm&quot;
)</code></pre>
<pre><code>## Warning: Removed 20 rows containing missing values (position_stack).</code></pre>
<pre class="r"><code>ggsave(
  filename = &quot;figs/dominance_fig.jpg&quot;,
  width = 8.84,
  height = 9,
  units = &quot;cm&quot;
)</code></pre>
<pre><code>## Warning: Removed 20 rows containing missing values (position_stack).</code></pre>
<p>Now I need to display the average values for these dominant species,
perhaps along with their standard deviations. I think I’ll just do this
for each treatment in the most recent measurement period.</p>
<pre class="r"><code>spp_dom_raw() %&gt;%
  group_by(year, treatment, measure) %&gt;%
  summarise(average = mean(value)) %&gt;%
  arrange(measure, treatment, year) %&gt;%
  pivot_wider(names_from = treatment, values_from = average) %&gt;%
  relocate(measure) %&gt;%
  kbl2(
    caption = &quot;Average metrics for top 100 TPH (ranked by the respective metric)&quot;,
    digits = 2)</code></pre>
<pre><code>## Warning in spp_dom_raw(): Measures missing values (entries removed): ba_inc2</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Average metrics for top 100 TPH (ranked by the respective metric)
</caption>
<thead>
<tr>
<th style="text-align:left;">
measure
</th>
<th style="text-align:left;">
year
</th>
<th style="text-align:right;">
C
</th>
<th style="text-align:right;">
H40
</th>
<th style="text-align:right;">
H80
</th>
<th style="text-align:right;">
L40
</th>
<th style="text-align:right;">
L80
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
ba_inc2
</td>
<td style="text-align:left;">
13
</td>
<td style="text-align:right;">
51.09
</td>
<td style="text-align:right;">
84.40
</td>
<td style="text-align:right;">
76.35
</td>
<td style="text-align:right;">
61.10
</td>
<td style="text-align:right;">
67.30
</td>
</tr>
<tr>
<td style="text-align:left;">
ba_inc2
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:right;">
64.82
</td>
<td style="text-align:right;">
105.16
</td>
<td style="text-align:right;">
90.52
</td>
<td style="text-align:right;">
76.59
</td>
<td style="text-align:right;">
70.82
</td>
</tr>
<tr>
<td style="text-align:left;">
dbh
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:right;">
40.54
</td>
<td style="text-align:right;">
41.72
</td>
<td style="text-align:right;">
40.91
</td>
<td style="text-align:right;">
38.69
</td>
<td style="text-align:right;">
39.85
</td>
</tr>
<tr>
<td style="text-align:left;">
dbh
</td>
<td style="text-align:left;">
13
</td>
<td style="text-align:right;">
43.63
</td>
<td style="text-align:right;">
47.09
</td>
<td style="text-align:right;">
45.24
</td>
<td style="text-align:right;">
42.09
</td>
<td style="text-align:right;">
43.98
</td>
</tr>
<tr>
<td style="text-align:left;">
dbh
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:right;">
47.39
</td>
<td style="text-align:right;">
52.49
</td>
<td style="text-align:right;">
50.40
</td>
<td style="text-align:right;">
46.66
</td>
<td style="text-align:right;">
48.40
</td>
</tr>
<tr>
<td style="text-align:left;">
ht_p
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:right;">
27.26
</td>
<td style="text-align:right;">
25.95
</td>
<td style="text-align:right;">
25.69
</td>
<td style="text-align:right;">
26.03
</td>
<td style="text-align:right;">
25.28
</td>
</tr>
<tr>
<td style="text-align:left;">
ht_p
</td>
<td style="text-align:left;">
13
</td>
<td style="text-align:right;">
28.44
</td>
<td style="text-align:right;">
27.65
</td>
<td style="text-align:right;">
27.77
</td>
<td style="text-align:right;">
28.08
</td>
<td style="text-align:right;">
27.74
</td>
</tr>
<tr>
<td style="text-align:left;">
ht_p
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:right;">
30.33
</td>
<td style="text-align:right;">
29.72
</td>
<td style="text-align:right;">
30.45
</td>
<td style="text-align:right;">
30.26
</td>
<td style="text-align:right;">
30.38
</td>
</tr>
</tbody>
</table>
</div>
<div id="species-dominance-significance-test" class="section level2">
<h2>Species dominance significance test</h2>
<p>A Wilcoxon rank-sum test could be used to test if one treatment
results in changes that are significantly greater than another
treatment. Unfortunately, it seems like none of the treatments that show
an average increase in the number of dominant SESE are significant at
the alpha = 0.05 level, using a 1-sided test. One-sided permutation
tests shows even larger p-values, and these I would expect to be more
accurate given the number of zeros in the data.</p>
<p>To start, I will only test significance for dbh ranked dominance, to
see if treatment effect is significant there. first I get a list of
differences from 2008 to 2018 for each plot in a treatment, this
represents the treatments effect on redwood dominance. Then I compare
the treatments to see is ones with a larger average effect, are
significantly larger than those with a smaller average effect: 1-sided
non-parametric tests. Wilcox rank-sum has lower p-values, than the
permutation test. The data has a lot of zeros, and very few data points,
none of the one-sided differences are significant. It is too soon to
tell if redwood dominance has been affected.</p>
<pre class="r"><code># This is the permutation calculation

new_diff &lt;- function(d_null) {
  new_samp &lt;- sample(d_null)
  mean(new_samp[5:8]) - mean(new_samp[1:4])
}

perm_test &lt;- function(x, y, M = 1e5) {
  obs_diff &lt;- mean(x) - mean(y)
  d_null &lt;- c(x, y)
  perm_diff &lt;- replicate(M, new_diff(d_null))
  sum(perm_diff &gt;= obs_diff) / M
}

# Takes one of my dominance metrics: dbh, ht, ba_inc2

non_para_dom_test &lt;- function(metric) {
  # only 2013 and 2018 available for basal area increment
  if(metric == &quot;ba_inc2&quot;) years &lt;- c(&quot;13&quot;, &quot;18&quot;) else years &lt;- c(&quot;08&quot;, &quot;18&quot;)
  
  # summarize differences between 2018 and 2013 for each treatment
  # (plot differences)
  W1 &lt;- spp_dom_cnt(metrics = metric, years = years) %&gt;%
    filter(spp == &quot;SESE3&quot;) %&gt;%
    group_by(plot) %&gt;%
    mutate(diff = n - lag(n)) %&gt;%
    drop_na() %&gt;%
    ungroup() %&gt;%
    select(treatment, measure, diff)
    
  W &lt;- with(W1, split(diff, treatment))

  # Get all combinations of treatments, where average change of treatment 1
  # is greater than the average for treatment 2

  combos &lt;- W1 %&gt;%
    group_by(treatment, measure) %&gt;%
    nest_by() %&gt;%
    mutate(avg = map_dbl(data, mean)) %&gt;%
    expand_grid(a = ., b = .) %&gt;%
    mutate(diff = a$avg - b$avg) %&gt;%
    arrange(desc(diff)) %&gt;%
    filter(diff &gt; 0) %&gt;%
    transmute(treat.a = a$treatment, treat.b = b$treatment)
  
  print(paste0(&quot;Test for &quot;, metric, &quot;:&quot;))

  apply(combos, 1, function(x) {
    wilout &lt;- wilcox.test(W[[ x[1] ]], W[[ x[2] ]], alternative = &quot;g&quot;)
    permout &lt;- perm_test(W[[ x[1] ]], W[[ x[2] ]])
    list(test = paste(x[1], &quot;&gt;&quot;, x[2]), Wilcox.P = wilout$p.value, Perm.P = permout)  
  }) %&gt;%
    bind_rows()
}</code></pre>
<pre class="r"><code>non_para_dom_test(&quot;dbh&quot;)</code></pre>
<pre><code>## [1] &quot;Test for dbh:&quot;</code></pre>
<pre><code>## # A tibble: 8 x 3
##   test      Wilcox.P Perm.P
##   &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;
## 1 H80 &gt; L40   0.0668  0.142
## 2 L80 &gt; L40   0.0668  0.143
## 3 C &gt; L40     0.310   0.285
## 4 H40 &gt; L40   0.128   0.287
## 5 H80 &gt; C     0.321   0.503
## 6 H80 &gt; H40   0.304   0.499
## 7 L80 &gt; C     0.321   0.499
## 8 L80 &gt; H40   0.304   0.498</code></pre>
<pre class="r"><code>non_para_dom_test(&quot;ba_inc2&quot;)</code></pre>
<pre><code>## [1] &quot;Test for ba_inc2:&quot;</code></pre>
<pre><code>## # A tibble: 9 x 3
##   test      Wilcox.P Perm.P
##   &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;
## 1 C &gt; L40     0.0289 0.0571
## 2 L80 &gt; L40   0.0683 0.142 
## 3 C &gt; H40     0.103  0.187 
## 4 H80 &gt; L40   0.0668 0.143 
## 5 L80 &gt; H40   0.176  0.241 
## 6 H80 &gt; H40   0.215  0.328 
## 7 C &gt; H80     0.304  0.501 
## 8 H40 &gt; L40   0.369  0.500 
## 9 L80 &gt; H80   0.437  0.499</code></pre>
<pre class="r"><code>non_para_dom_test(&quot;ht&quot;)</code></pre>
<pre><code>## [1] &quot;Test for ht:&quot;</code></pre>
<pre><code>## # A tibble: 10 x 3
##    test      Wilcox.P Perm.P
##    &lt;chr&gt;        &lt;dbl&gt;  &lt;dbl&gt;
##  1 L80 &gt; H40   0.0316 0.0574
##  2 C &gt; H40     0.0902 0.100 
##  3 L80 &gt; L40   0.0671 0.0990
##  4 H80 &gt; H40   0.178  0.199 
##  5 L80 &gt; H80   0.231  0.213 
##  6 C &gt; L40     0.224  0.242 
##  7 L40 &gt; H40   0.5    0.301 
##  8 L80 &gt; C     0.221  0.297 
##  9 C &gt; H80     0.385  0.429 
## 10 H80 &gt; L40   0.385  0.429</code></pre>
</div>
<div id="huis-dominance-metric" class="section level1">
<h1>Hui’s dominance metric</h1>
<p>I first saw this metric in <span class="citation">Motz, Sterba, and
Pommerening (2010)</span>, where it appears to have been missapplied.
There, it was given as: <span class="math display">\[ U_i = \frac{1}{n}
\sum^{n}_{j=1} 1 (DBH_i &gt; DBH_j) \]</span></p>
<p>But they applied it to all trees, in which case, I assume that,
leaving aside the issue to ties, the average would have to be 0.5.</p>
<p>Here I will calculate the species dominance metric separately for
redwood and Douglas-fir components.</p>
<p>A stand composed of a single species should have an average Ui of
0.5</p>
<p>A species with more shade tolerance might have a lower Ui, because
there are more trees in the understory, brining down average Ui.</p>
<p>Ui for redwood decreases in the control. This would suggest that the
number of trees of other species out-competing (by diameter growth)
redwoods is increasing, assuming the 4 nearest trees are in competition
with any given tree. Because this metric is expressed as an average, it
doesn’t account for the density of the species.</p>
<pre class="r"><code># Use live trees
dd &lt;- d_l |&gt;
  filter(
    live,
    year != &quot;init&quot;
  ) |&gt;
  mutate(year = factor(year, ordered = FALSE)) |&gt;
  droplevels()

# calculate Ui for one observation, given observation number, dbh list and neighbors list
Ui_tree &lt;- function(x, dbh, k_indices) {
  focus_dbh &lt;- dbh[x]
  neighbors_dbh &lt;- dbh[ k_indices[[x]] ]
  mean(focus_dbh &gt; neighbors_dbh)
}

# Ui for all observations
calc_Ui &lt;- function(x, y, dbh) {
  xy &lt;- data.frame(x = x, y = y)
  k_indices &lt;- nearest(xy, k = 4)
  sapply( 1:nrow(xy), Ui_tree, dbh, k_indices)
}


Ui_plot &lt;- dd |&gt;
  group_by(treatment, year, plot) |&gt;
  mutate(val = calc_Ui(x, y, dbh)) |&gt;
  group_by(treatment, year, plot, spp) |&gt;
  summarize(val = mean(val)) |&gt;
  filter(spp %in% c(&quot;PSMEM&quot;, &quot;SESE3&quot;))

  
lmer(val ~ treatment * year * spp + (1 | plot), data = Ui_plot) |&gt;
  emmeans( ~ treatment + year + spp) |&gt; as.data.frame() |&gt;
  relevel_treatment() |&gt;
  mutate(
    spp = factor(spp, levels = c(&quot;SESE3&quot;, &quot;PSMEM&quot;))
  ) |&gt;
  ggplot(aes(year, emmean, color = spp, group = spp)) +
      geom_line(size = 1, position = my_dodge) +
      geom_point(position = my_dodge) +
      geom_errorbar(
        aes(ymin = emmean - SE, ymax = emmean + SE),
        width = .75,
        position = my_dodge
      ) +
      theme_bw() +
      facet_wrap( ~ treatment)     </code></pre>
<p><img src="10_species_dominance_files/figure-html/10-species-dominance-7-1.png" width="672" /></p>
<p>First, I’ll show the average number of trees and standard deviation
of each species in the top 100 TPH.</p>
<pre class="r"><code>dd |&gt;
  group_by(treatment, year, plot) |&gt;
  slice_max(n = 8, order_by = dbh, with_ties = TRUE) |&gt;
  group_by(treatment, year, spp) |&gt;
  count(plot) |&gt;
  summarize(avg_cnt = mean(n), sd = sd(n)) |&gt;
  filter(spp %in% c(&quot;SESE3&quot;, &quot;PSMEM&quot;)) |&gt;
  color_groups(digits = 2, caption = &quot;Average count and sd of number of DF or RW trees in the to 100 TPH per treatment/year&quot;)</code></pre>
<table class="table" style="width: auto !important; margin-left: auto; margin-right: auto;">
<caption>
Average count and sd of number of DF or RW trees in the to 100 TPH per
treatment/year
</caption>
<thead>
<tr>
<th style="text-align:left;">
treatment
</th>
<th style="text-align:left;">
year
</th>
<th style="text-align:left;">
spp
</th>
<th style="text-align:right;">
avg_cnt
</th>
<th style="text-align:right;">
sd
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
C
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
3.75
</td>
<td style="text-align:right;">
1.71
</td>
</tr>
<tr>
<td style="text-align:left;">
C
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
3.75
</td>
<td style="text-align:right;">
2.06
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
C
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
13
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
PSMEM
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
3.75
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
1.71
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
C
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
13
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
SESE3
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
3.75
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.06
</td>
</tr>
<tr>
<td style="text-align:left;">
C
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
3.50
</td>
<td style="text-align:right;">
1.91
</td>
</tr>
<tr>
<td style="text-align:left;">
C
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
4.00
</td>
<td style="text-align:right;">
2.45
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
H40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
08
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
PSMEM
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
4.00
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
1.73
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
H40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
08
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
SESE3
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
4.75
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.75
</td>
</tr>
<tr>
<td style="text-align:left;">
H40
</td>
<td style="text-align:left;">
13
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
3.67
</td>
<td style="text-align:right;">
2.31
</td>
</tr>
<tr>
<td style="text-align:left;">
H40
</td>
<td style="text-align:left;">
13
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
5.25
</td>
<td style="text-align:right;">
3.30
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
H40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
18
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
PSMEM
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
3.67
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.31
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
H40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
18
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
SESE3
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
5.00
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.94
</td>
</tr>
<tr>
<td style="text-align:left;">
H80
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
3.67
</td>
<td style="text-align:right;">
1.53
</td>
</tr>
<tr>
<td style="text-align:left;">
H80
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
3.75
</td>
<td style="text-align:right;">
2.36
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
H80
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
13
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
PSMEM
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
3.67
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
1.53
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
H80
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
13
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
SESE3
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
4.00
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.83
</td>
</tr>
<tr>
<td style="text-align:left;">
H80
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
3.33
</td>
<td style="text-align:right;">
1.15
</td>
</tr>
<tr>
<td style="text-align:left;">
H80
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
3.75
</td>
<td style="text-align:right;">
2.36
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
L40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
08
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
PSMEM
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
5.75
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.87
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
L40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
08
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
SESE3
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.67
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
1.53
</td>
</tr>
<tr>
<td style="text-align:left;">
L40
</td>
<td style="text-align:left;">
13
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
6.25
</td>
<td style="text-align:right;">
2.06
</td>
</tr>
<tr>
<td style="text-align:left;">
L40
</td>
<td style="text-align:left;">
13
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
2.00
</td>
<td style="text-align:right;">
1.41
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
L40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
18
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
PSMEM
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
6.25
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.06
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
L40
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
18
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
SESE3
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.00
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
1.41
</td>
</tr>
<tr>
<td style="text-align:left;">
L80
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
4.50
</td>
<td style="text-align:right;">
2.65
</td>
</tr>
<tr>
<td style="text-align:left;">
L80
</td>
<td style="text-align:left;">
08
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
3.25
</td>
<td style="text-align:right;">
2.87
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
L80
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
13
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
PSMEM
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
3.75
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.22
</td>
</tr>
<tr>
<td style="text-align:left;background-color: #EEE9E9 !important;">
L80
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
13
</td>
<td style="text-align:left;background-color: #EEE9E9 !important;">
SESE3
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
4.25
</td>
<td style="text-align:right;background-color: #EEE9E9 !important;">
2.22
</td>
</tr>
<tr>
<td style="text-align:left;">
L80
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:left;">
PSMEM
</td>
<td style="text-align:right;">
4.00
</td>
<td style="text-align:right;">
2.16
</td>
</tr>
<tr>
<td style="text-align:left;">
L80
</td>
<td style="text-align:left;">
18
</td>
<td style="text-align:left;">
SESE3
</td>
<td style="text-align:right;">
3.75
</td>
<td style="text-align:right;">
1.71
</td>
</tr>
</tbody>
</table>
<p>Here I plot the average Ui of RW or DF trees that are in the top 100
TPH.</p>
<pre class="r"><code>Ui_plot2 &lt;- dd |&gt;
  group_by(treatment, year, plot) |&gt;
  mutate(val = calc_Ui(x, y, dbh)) |&gt;
  slice_max(n = 8, order_by = dbh, with_ties = TRUE) |&gt;
  group_by(treatment, year, plot, spp) |&gt;
  summarize(val = mean(val)) |&gt;
  filter(spp %in% c(&quot;PSMEM&quot;, &quot;SESE3&quot;))

  
Ui_mod2 &lt;- lmer(val ~ treatment * year * spp + (1 | plot), data = Ui_plot2)

emmeans(Ui_mod2, pairwise ~ spp | treatment + year)$contrasts</code></pre>
<pre><code>## treatment = C, year = 08:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.01562 0.0549 64.2   0.285  0.7768
## 
## treatment = H40, year = 08:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.05269 0.0601 66.6   0.877  0.3837
## 
## treatment = H80, year = 08:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3 -0.00672 0.0601 66.6  -0.112  0.9112
## 
## treatment = L40, year = 08:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3 -0.09803 0.0601 66.6  -1.631  0.1075
## 
## treatment = L80, year = 08:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.04539 0.0549 64.2   0.827  0.4113
## 
## treatment = C, year = 13:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.01562 0.0549 64.2   0.285  0.7768
## 
## treatment = H40, year = 13:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.14892 0.0601 66.6   2.478  0.0157
## 
## treatment = H80, year = 13:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3 -0.04058 0.0601 66.6  -0.675  0.5018
## 
## treatment = L40, year = 13:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3 -0.15194 0.0692 68.7  -2.197  0.0314
## 
## treatment = L80, year = 13:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.07827 0.0549 64.2   1.426  0.1587
## 
## treatment = C, year = 18:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.13021 0.0549 64.2   2.372  0.0207
## 
## treatment = H40, year = 18:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.15255 0.0601 66.6   2.539  0.0135
## 
## treatment = H80, year = 18:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3 -0.05033 0.0601 66.6  -0.837  0.4053
## 
## treatment = L40, year = 18:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3 -0.13371 0.0692 68.7  -1.934  0.0573
## 
## treatment = L80, year = 18:
##  contrast      estimate     SE   df t.ratio p.value
##  PSMEM - SESE3  0.02500 0.0549 64.2   0.456  0.6503
## 
## Degrees-of-freedom method: kenward-roger</code></pre>
<pre class="r"><code>emmeans(Ui_mod2, ~ treatment + year + spp) |&gt; 
  as.data.frame() |&gt;
  relevel_treatment() |&gt;
  mutate(
    spp = factor(spp, levels = c(&quot;SESE3&quot;, &quot;PSMEM&quot;))
  ) |&gt;
  ggplot(aes(year, emmean, color = spp, group = spp)) +
      geom_line(size = 1, position = my_dodge) +
      geom_point(position = my_dodge) +
      geom_errorbar(
        aes(ymin = emmean - SE, ymax = emmean + SE),
        width = .75,
        position = my_dodge
      ) +
      theme_bw() +
      facet_wrap( ~ treatment)      </code></pre>
<p><img src="10_species_dominance_files/figure-html/10-species-dominance-9-1.png" width="672" /></p>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-motzSamplingMeasuresTree2010" class="csl-entry">
Motz, K., H. Sterba, and A. Pommerening. 2010. <span>“Sampling Measures
of Tree Diversity.”</span> <em>Forest Ecology and Management</em> 260
(11): 1985–96. <a
href="https://doi.org/10.1016/j.foreco.2010.08.046">https://doi.org/10.1016/j.foreco.2010.08.046</a>.
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
