---
title: "Define new data"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = TRUE, message = FALSE)
```

## Defining live/dead trees

Status and condition codes provided do not necessarily define mortality, because a broken tree, depending on species may still be alive or dead. I'll define dead trees as:

1. snags or down snags (status -9 to -5, and 5 to 9)
2. trees broken below dbh and uprooted trees (status 30, 32)
3. any non-sprouting species broken above dbh (status 31)
4. any sprouting species broken below 3 meters
5. missing live trees


```{r define-live}

d_l <- d_l %>%
  mutate(
    live = case_when(
      status %in% c(5:9, -5:-9, -1)                                  ~ FALSE,
      status %in% c(30, 32)                                      ~ FALSE,
      (spp %in% c("PSMEM", "PISI") & status == 31)               ~ FALSE,
      (spp %in% c("SESE3", "ALRU") & status == 31 & ht < 3)      ~ FALSE,
      (spp %in% c("SESE3", "ALRU") & status == 31 & lag(ht) < 3) ~ FALSE,
      TRUE                                                       ~ TRUE
    )
  )

# Do any trees go from being dead to being alive?
nrow(filter(group_by(d_l, tree_id), any(!live & lead(live))))

```

## Define diameter, basal area, and height increment

I looked at increment earlier to try to suss out bad dbh entries. Here I will add annual height, diameter and basal area increments to the long-form dataset.

```{r}
# Add diameter increment data and update post-harvest data
d_l <- d_l %>%
  group_by(tree_id) %>%
  mutate(
    d_inc = (dbh - lag(dbh, order_by = year)) / 5,
    ht_inc = (ht - lag(ht, order_by = year)) / 5,
    ba = pi * (dbh / 2)^2,
    ba_inc = (ba - lag(ba, order_by = year)) / 5
  ) %>%
  ungroup()
```


## Define UTM coordinates for each tree

```{r}
d_l <- d_l %>%
  left_join(plot_info[, c("plot", "utm_x", "utm_y")], by = "plot") %>%
  mutate(
    circular2xy(h_dist, azi, center.x = utm_x, center.y = utm_y)
  ) %>%
  select(-c(utm_x, utm_y))
```

## Structural diversity SCI

```{r}
library(geometry)
# calculate within plot coordinates, plot center = origin
# this does not work with missing values currently.
# d_l %>%
#   group_by(plot, year) %>%
#   mutate(
#     circular2xy(h_dist, azi),
#     sci_ht = sci_metric(x, y, ht),
#     sci_d = sci_metric(x, y, dbh)
#   ) %>%
#   arrange(plot, year)
# temp <- d_l %>% filter(plot == "1H40", year == "18") %>% select(h_dist, azi, ht, dbh)
```

## Update post-harvest data

Make sure that this is the last step

```{r}
p_h <- filter(d_l, year > "init")
```
